<?xml version="1.0" encoding="UTF-8"?>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">
    <service verb="create" noun="InventoryItemDetail">
        <in-parameters>
            <auto-parameters entity-name="org.apache.ofbiz.product.inventory.InventoryItemDetail"/>
        </in-parameters>
        <out-parameters>
            <parameter name="inventoryItemDetailSeqId"/>
        </out-parameters>
        <actions>
            <entity-make-value entity-name="org.apache.ofbiz.product.inventory.InventoryItemDetail" value-field="newEntity" map="context"/>
            <!--
                InventoryItemDetail has multiple primary keys, and EntityAuto services use the
                entityValue.setSequencedIdSecondary method to get the maximum secondary sequence ID from existing InventoryItemDetail records.
                If the system has a large number of InventoryItemDetail records, this approach may slow down the record creation process and cause performance issues.
                Hence, the sequencedIdPrimaryEd method is used instead to generate the next sequence ID, similar to the implementation in OFBiz.
            -->

            <set field="itemDetailED" from="ec.entity.getEntityDefinition('org.apache.ofbiz.product.inventory.InventoryItemDetail')"/>
            <set field="newEntity.inventoryItemDetailSeqId" from="ec.entityFacade.sequencedIdPrimaryEd(itemDetailED)"/>
            <set field="inventoryItemDetailSeqId" from="newEntity.inventoryItemDetailSeqId"/>

            <entity-find-one entity-name="co.hotwax.oms.product.inventory.InventoryItemDetailSummary" value-field="inventoryItemDetailSummary"/>
            <set field="newEntity.lastQuantityOnHand" from="inventoryItemDetailSummary?.quantityOnHandTotal" default-value="0"/>
            <set field="newEntity.lastAvailableToPromise" from="inventoryItemDetailSummary?.availableToPromiseTotal" default-value="0"/>

            <if condition="!newEntity.availableToPromiseDiff">
                <set field="newEntity.availableToPromiseDiff" value="0" type="BigDecimal"/>
            </if>
            <if condition="!newEntity.quantityOnHandDiff">
                <set field="newEntity.quantityOnHandDiff" value="0" type="BigDecimal"/>
            </if>
            <entity-create value-field="newEntity"/>
        </actions>
    </service>
    <service verb="update" noun="InventoryItemFromDetail" no-tx-cache="true">
        <description>Called by EECA rule to update InventoryItem quantities when an InventoryItemDetail record is created.</description>
        <in-parameters>
            <parameter name="inventoryItemId" required="true"/>
            <parameter name="availableToPromiseDiff" type="BigDecimal"/>
            <parameter name="quantityOnHandDiff" type="BigDecimal"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="org.apache.ofbiz.product.inventory.InventoryItem" value-field="inventoryItem" for-update="true">
                <field-map field-name="inventoryItemId" from="inventoryItemId"/>
            </entity-find-one>

            <!--
            <log message="InventoryItem [Inventory Item ID: ${inventoryItemId}] - Start update from detail: ${availableToPromiseDiff}/${quantityOnHandDiff} :: ${inventoryItem.availableToPromiseTotal}/${inventoryItem.quantityOnHandTotal}"/>
            -->
            <!-- View queries won't work with transaction cache (for data updated within the tx), so if active use different approach -->
            <if condition="ec.transaction.isTransactionCacheActive()"><then>
                <!-- incremental update -->
                <set field="inventoryItem.availableToPromiseTotal" from="(inventoryItem.availableToPromiseTotal ?: 0.0) + (availableToPromiseDiff ?: 0.0)"/>
                <set field="inventoryItem.quantityOnHandTotal" from="(inventoryItem.quantityOnHandTotal ?: 0.0) + (quantityOnHandDiff ?: 0.0)"/>
            </then><else>
                <!-- sum all records, update with new totals -->
                <entity-find-one entity-name="co.hotwax.oms.product.inventory.InventoryItemDetailSummary" value-field="inventoryItemDetail">
                    <field-map field-name="inventoryItemId" from="inventoryItemId"/>
                    <select-field field-name="availableToPromiseTotal,quantityOnHandTotal"/>
                </entity-find-one>
                <set field="inventoryItem.availableToPromiseTotal" from="inventoryItemDetail.availableToPromiseTotal ?: 0.0"/>
                <set field="inventoryItem.quantityOnHandTotal" from="inventoryItemDetail.quantityOnHandTotal ?: 0.0"/>
            </else></if>

            <entity-update value-field="inventoryItem"/>
            <service-call name="co.hotwax.oms.product.ProductServices.update#ProductFacility"
                          in-map="[productId: inventoryItem.productId, facilityId: inventoryItem.facilityId, lastInventoryCount: inventoryItem.availableToPromiseTotal]" ignore-error="true"/>
            <!--
            <set field="message" from="'========== end update#InventoryItemFromDetail ' + inventoryItemID + ': ' + availableToPromiseDiff + '/' + quantityOnHandDiff + ' :: ' + inventoryItem.availableToPromiseTotal + '/' + inventoryItem.quantityOnHandTotal"/>
            <log message="${message}"/>
            -->
        </actions>
    </service>

    <service verb="get" noun="ProductOnlineAtp" authenticate="anonymous-all">
        <in-parameters>
            <parameter name="productStoreId" required="true"/>
            <parameter name="facilityGroupId"/>
            <parameter name="productId" type="List"/>
            <parameter name="sku" type="List"/>
        </in-parameters>
        <out-parameters>
            <parameter name="productOnlineAtp" type="List"/>
        </out-parameters>
        <actions>
            <if condition="!productId &amp;&amp; !sku">
                <return error="true" message="Either productId or sku are required."/>
            </if>

            <set field="productSkuMap" from="[:]"/>
            <if condition="!productId">
                <entity-find entity-name="org.apache.ofbiz.product.product.Product" list="productList" use-clone="true">
                    <econdition field-name="internalName" operator="in" from="sku"/>
                    <select-field field-name="productId,internalName"/>
                </entity-find>
                <if condition="productList">
                    <set field="productId" from="productList*.productId"/>
                </if>
                <iterate list="productList" entry="p">
                    <set field="productSkuMap[p.productId]" from="p.internalName"/>
                </iterate>
            </if>

            <entity-find-one entity-name="org.apache.ofbiz.product.store.ProductStoreSetting" value-field="isHoldPreorderPhysicalInv" cache="true" use-clone="true">
                <field-map field-name="productStoreId" from="productStoreId"/>
                <field-map field-name="settingTypeEnumId" value="HOLD_PRORD_PHYCL_INV"/>
                <field-map field-name="settingValue" value="true"/>
            </entity-find-one>

            <entity-find entity-name="co.hotwax.facility.ProductFacilityAndGroupAtp" list="productFacilityAtpList" use-clone="true">
                <econdition field-name="productId" from="productId" operator="in"/>
                <econdition field-name="productStoreId" from="productStoreId"/>
                <econditions combine="or">
                    <econdition field-name="allowBrokering" operator="is-null"/>
                    <econdition field-name="allowBrokering" value="Y"/>
                </econditions>
                <econdition field-name="facilityGroupTypeId" value="CHANNEL_FAC_GROUP"/>
                <econdition field-name="facilityGroupId" from="facilityGroupId" ignore-if-empty="true"/>
                <econdition field-name="facilityParentTypeId" operator="not-equals" value="VIRTUAL_FACILITY"/>
                <date-filter/>
                <date-filter from-field-name="psfFromDate" thru-field-name="psfThruDate"/>
                <select-field field-name="productId,atp"/>
            </entity-find>

            <set field="virtualQueueCountMap" from="[:]" />
            <entity-find-one entity-name="org.apache.ofbiz.product.store.ProductStore" value-field="productStore" cache="true" use-clone="true">
                <field-map field-name="productStoreId"/>
                <select-field field-name="reserveInventory"/>
            </entity-find-one>
            <if condition="productStore &amp;&amp; !'N'.equals(productStore.reserveInventory)">
                <entity-find entity-name="co.hotwax.warehouse.VirtualFacilityOrderItemCount" list="virtualQueueCountList" use-clone="true">
                    <econdition field-name="productId" from="productId" operator="in"/>
                    <econdition field-name="orderTypeId" value="SALES_ORDER"/>
                    <econdition field-name="productStoreId" from="productStoreId"/>
                    <econdition field-name="itemStatusId" operator="not-in" from="['ITEM_CANCELLED', 'ITEM_COMPLETED', 'ITEM_REJECTED']"/>
                    <select-field field-name="productId,itemCount"/>
                </entity-find>

                <iterate list="virtualQueueCountList" entry="vfc">
                    <set field="virtualQueueCountMap[vfc.productId]" from="vfc.itemCount"/>
                </iterate>
            </if>

            <set field="productOnlineAtp" from="[]"/>
            <iterate list="productFacilityAtpList" entry="productFacility">
                <set field="currProductId" from="productFacility.productId"/>

                <if condition="isHoldPreorderPhysicalInv">
                    <entity-find entity-name="co.hotwax.warehouse.VirtualFacilityOrderItemCount" list="pendingOrderCountList" use-clone="true">
                        <econdition field-name="productId" from="currProductId"/>
                        <econdition field-name="orderTypeId" value="SALES_ORDER"/>
                        <econdition field-name="productStoreId" from="productStoreId"/>
                        <econdition field-name="facilityId" from="['PRE_ORDER_PARKING', 'BACKORDER_PARKING']"/>
                        <econdition field-name="itemStatusId" operator="not-in" from="['ITEM_CANCELLED', 'ITEM_COMPLETED', 'ITEM_REJECTED']"/>
                        <select-field field-name="productId,facilityId,itemCount"/>
                    </entity-find>
                    <set field="preOrderCount" from="prendingOrderCountList.find { it.facilityId == 'PRE_ORDER_PARKING' }?.itemCount ?: 0.0" type="BigDecimal"/>
                    <set field="backOrderCount" from="prendingOrderCountList.find { it.facilityId == 'BACKORDER_PARKING' }?.itemCount ?: 0.0" type="BigDecimal"/>
                    <if condition="preOrderCount > 0.0 || backOrderCount > 0.0">
                        <script>productOnlineAtp.add([productId: currProductId, sku: productSkuMap[currProductId], atp: 0.0])</script>
                        <continue/>
                    </if>
                </if>
                <set field="atp" from="productFacility.atp ?: 0.0" type="BigDecimal"/>

                <!-- Check Allow brokering at global level and threshold value -->
                <entity-find entity-name="co.hotwax.warehouse.ProductFacilityAndGroup" list="configProductFacilityList" cache="true" use-clone="true">
                    <econdition field-name="facilityTypeId" value="CONFIGURATION"/>
                    <econdition field-name="productId" from="currProductId"/>
                    <econdition field-name="facilityGroupId" from="facilityGroupId" ignore-if-empty="true"/>
                    <select-field field-name="allowBrokering,minimumStock"/>
                    <order-by field-name="-minimumStock"/>
                </entity-find>
                <filter-map-list list="configProductFacilityList" to-list="configProductFacilityList">
                    <date-filter/>
                    <date-filter from-field-name="psfFromDate" thru-field-name="psfThruDate"/>
                </filter-map-list>

                <set field="configProductFacility" from="configProductFacilityList.getAt(0)"/>
                <set field="threshold" from="configProductFacility?.minimumStock ?: 0.0" type="BigDecimal"/>
                <set field="atp" from="atp.subtract(threshold).subtract(virtualQueueCountMap[currProductId]?:0.0)" type="BigDecimal"/>

                <if condition="configProductFacility &amp;&amp; 'N'.equals(configProductFacility?.allowBrokering)">
                    <set field="atp" from="0.0"/>
                </if>
                <script>productOnlineAtp.add([productId: currProductId, sku: productSkuMap[currProductId], atp: Math.max(0.0, atp)])</script>
            </iterate>
        </actions>
    </service>
</services>