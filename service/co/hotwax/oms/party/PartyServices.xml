<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="https://moqui.org/xsd/service-definition-3.xsd">

    <service verb="store" noun="Picker">
        <description>
            Translated from the legacy Ofbiz pickerDataSetup. Creates or re-enables a picker (person) by externalPartyId,
            validates status/dates/facility, manages PartyRole, assigns facility roles, and expires roles when terminated.
        </description>
        <in-parameters>
            <parameter name="externalPartyId" required="true"/>
            <parameter name="firstName" required="true"/>
            <parameter name="lastName"/>
            <parameter name="emailAddress"/>
            <parameter name="contactNumber"/>
            <parameter name="externalFacilityId"/>
            <parameter name="roleTypeId" default-value="PICKER"/>
            <parameter name="status" required="true">
                <description>Expected values: A (active) or T (terminated).</description>
            </parameter>
            <parameter name="fromDate"/>
            <parameter name="thruDate"/>
            <parameter name="roleTypeIds" type="List">
                <description>Optional additional roleTypeIds to include alongside roleTypeId.</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="partyId"/>
            <parameter name="facilityId"/>
            <parameter name="fromDate" type="Timestamp"/>
            <parameter name="thruDate" type="Timestamp"/>
        </out-parameters>
        <actions>
            <set field="nowTs" from="ec.user.nowTimestamp"/>
            <set field="todayStart" from="java.sql.Timestamp.valueOf(nowTs.toLocalDateTime().toLocalDate().atStartOfDay())"/>

            <set field="roleTypes"
                 from="(((roleTypeIds ?: []) + (roleTypeId ? [roleTypeId] : []) + ((externalFacilityId &amp;&amp; externalFacilityId == '0') ? ['EMPLOYEE'] : [])).findAll{it}).unique()"/>

            <set field="partyStatusId" from="status == 'T' ? 'PARTY_DISABLED' : 'PARTY_ENABLED'"/>
            <log level="info" message="store#Picker start externalPartyId=${externalPartyId}, status=${status}, externalFacilityId=${externalFacilityId}"/>

            <if condition="!externalPartyId">
                <script>ec.message.addError("External Party Id is required")</script>
            </if>
            <if condition="!firstName">
                <script>ec.message.addError("First Name is required")</script>
            </if>
            <if condition="!status">
                <script>ec.message.addError("Status is required - Should be either 'T' or 'A'. T stands for Inactive and A stands for Active users")</script>
            <else-if condition="!(status in ['T','A'])">
                <script>ec.message.addError("Invalid Status value - Status should be either 'T' or 'A'. T stands for Inactive and A stands for Active users")</script>
            </else-if>
            </if>

            <if condition="fromDate &amp;&amp; fromDate != 'NULL'">
                <set field="fromDateTs" from="ec.l10n.parseTimestamp(fromDate, 'MM/dd/yyyy', null, null)"/>
                <if condition="!fromDateTs">
                    <script>ec.message.addError("Invalid fromDate - expected format MM/dd/yyyy: ${fromDate}")</script>
                </if>
            </if>
            <if condition="thruDate &amp;&amp; thruDate != 'NULL'">
                <set field="thruDateTs" from="ec.l10n.parseTimestamp(thruDate, 'MM/dd/yyyy', null, null)"/>
                <if condition="!thruDateTs">
                    <script>ec.message.addError("Invalid thruDate - expected format MM/dd/yyyy: ${thruDate}")</script>
                </if>
            </if>
            <if condition="!fromDateTs &amp;&amp; fromDate != 'NULL'">
                <set field="fromDateTs" from="ec.user.nowTimestamp"/>
            </if>
            <if condition="!thruDateTs &amp;&amp; status == 'T'">
                <set field="thruDateTs" from="nowTs"/>
            </if>

            <if condition="externalFacilityId">
                <entity-find entity-name="org.apache.ofbiz.product.facility.Facility" list="facilityList" limit="1">
                    <econdition field-name="externalId" from="externalFacilityId"/>
                </entity-find>
                <if condition="!facilityList">
                    <script>ec.message.addError("Facility with facility Id: ${externalFacilityId} Does Not Exists.")</script>
                <else>
                    <set field="facilityId" from="facilityList[0].facilityId"/>
                </else>
                </if>
            </if>

            <entity-find entity-name="org.apache.ofbiz.party.party.Party" list="partyList" limit="1">
                <econdition field-name="externalId" from="externalPartyId"/>
            </entity-find>
            <if condition="partyList">
                <set field="party" from="partyList[0]"/>
                <set field="partyId" from="party.partyId"/>
            </if>
            <if condition="ec.message.hasError()">
                <return/>
            </if>

            <if condition="partyId">
                <log level="info" message="store#Picker existing party ${partyId}, status=${status}"/>
                <if condition="status == 'A' &amp;&amp; party.statusId != 'PARTY_ENABLED'">
                    <service-call name="update#org.apache.ofbiz.party.party.Party" in-map="[partyId:partyId, statusId:'PARTY_ENABLED']"/>
                </if>
                <if condition="status == 'T' &amp;&amp; party.statusId != 'PARTY_DISABLED'">
                    <service-call name="update#org.apache.ofbiz.party.party.Party" in-map="[partyId:partyId, statusId:'PARTY_DISABLED']"/>
                </if>
                <if condition="status == 'A'">
                    <iterate list="roleTypes" entry="roleType">
                        <entity-find entity-name="org.apache.ofbiz.party.party.PartyRole" list="partyRoleList" limit="1">
                            <econdition field-name="partyId" from="partyId"/>
                            <econdition field-name="roleTypeId" from="roleType"/>
                        </entity-find>
                        <if condition="!partyRoleList">
                            <service-call name="create#org.apache.ofbiz.party.party.PartyRole" in-map="[partyId:partyId, roleTypeId:roleType]"/>
                        </if>
                    </iterate>
                </if>
            </if>

            <if condition="!partyId">
                <log level="info" message="store#Picker creating new party for externalPartyId=${externalPartyId}"/>
                <service-call name="create#org.apache.ofbiz.party.party.Party" out-map="createPartyOut"
                              in-map="[partyTypeId:'PERSON', externalId:externalPartyId, statusId:partyStatusId]"/>
                <set field="partyId" from="createPartyOut.partyId"/>
                <service-call name="create#org.apache.ofbiz.party.party.Person" in-map="[partyId:partyId, firstName:firstName, lastName:lastName]"/>

                <if condition="emailAddress">
                    <service-call name="create#org.apache.ofbiz.party.contact.ContactMech" out-map="emailOut"
                                  in-map="[contactMechTypeId:'EMAIL_ADDRESS', infoString:emailAddress]"/>
                    <service-call name="create#org.apache.ofbiz.party.contact.PartyContactMech"
                                  in-map="[partyId:partyId, contactMechId:emailOut.contactMechId, fromDate:fromDateTs, allowSolicitation:'Y']"/>
                    <service-call name="create#org.apache.ofbiz.party.contact.PartyContactMechPurpose" ignore-error="true"
                                  in-map="[partyId:partyId, contactMechId:emailOut.contactMechId, contactMechPurposeTypeId:'PRIMARY_EMAIL', fromDate:fromDateTs]"/>
                </if>
                <if condition="contactNumber">
                    <service-call name="create#org.apache.ofbiz.party.contact.ContactMech" out-map="phoneOut"
                                  in-map="[contactMechTypeId:'TELECOM_NUMBER']"/>
                    <service-call name="create#org.apache.ofbiz.party.contact.TelecomNumber"
                                  in-map="[contactMechId:phoneOut.contactMechId, contactNumber:contactNumber]"/>
                    <service-call name="create#org.apache.ofbiz.party.contact.PartyContactMech"
                                  in-map="[partyId:partyId, contactMechId:phoneOut.contactMechId, fromDate:fromDateTs]"/>
                    <service-call name="create#org.apache.ofbiz.party.contact.PartyContactMechPurpose" ignore-error="true"
                                  in-map="[partyId:partyId, contactMechId:phoneOut.contactMechId, contactMechPurposeTypeId:'PRIMARY_PHONE', fromDate:fromDateTs]"/>
                </if>

                <iterate list="roleTypes" entry="roleType">
                    <entity-find entity-name="org.apache.ofbiz.party.party.PartyRole" list="partyRoleList" limit="1">
                        <econdition field-name="partyId" from="partyId"/>
                        <econdition field-name="roleTypeId" from="roleType"/>
                    </entity-find>
                    <if condition="!partyRoleList">
                        <service-call name="create#org.apache.ofbiz.party.party.PartyRole" in-map="[partyId:partyId, roleTypeId:roleType]"/>
                    </if>
                </iterate>

                <if condition="facilityId">
                    <log level="info" message="store#Picker linking party ${partyId} to facility ${facilityId} as WAREHOUSE_PICKER"/>
                    <iterate list="['WAREHOUSE_PICKER']" entry="facRole">
                        <entity-find entity-name="org.apache.ofbiz.party.party.PartyRole" list="pickerRole" limit="1">
                            <econdition field-name="partyId" from="partyId"/>
                            <econdition field-name="roleTypeId" from="facRole"/>
                        </entity-find>
                        <if condition="!pickerRole">
                            <service-call name="create#org.apache.ofbiz.party.party.PartyRole" in-map="[partyId:partyId, roleTypeId:facRole]"/>
                        </if>
                    </iterate>
                    <service-call name="create#org.apache.ofbiz.product.facility.FacilityParty"
                                  in-map="[facilityId:facilityId, partyId:partyId, roleTypeId:'WAREHOUSE_PICKER', fromDate:fromDateTs, thruDate:thruDateTs]"/>
                </if>
            </if>

            <set field="context.partyId" from="partyId"/>
            <set field="context.facilityId" from="facilityId"/>
            <set field="context.fromDate" from="fromDateTs"/>
            <set field="context.thruDate" from="thruDateTs"/>
        </actions>
    </service>
</services>
