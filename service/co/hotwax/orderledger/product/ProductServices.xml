<?xml version="1.0" encoding="UTF-8"?>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="create" noun="ProductAndVariants">
        <description>Service to create the virtual and variant products.</description>
        <in-parameters>
            <parameter name="payload" type="Map" required="true">
                <description>The payload containing product and its variants.</description>
            </parameter>
        </in-parameters>
        <actions>
            <!-- Set the productVariants field from the incoming payload map -->
            <set field="productVariants" from="payload.remove('variants')"/>

            <!-- Call the create#VirtualProduct service -->
            <service-call name="co.hotwax.orderledger.product.ProductServices.create#VirtualProduct"
                    in-map="[productJson:payload]" out-map="createVirtualProductOut" transaction="force-new"/>

            <!-- Set the parentProductId returned from the create#VirtualProduct service -->
            <set field="parentProductId" from="createVirtualProductOut.productId"/>

            <!-- Set the variantErrors list to store the errors occurred while creating variant product -->
            <set field="variantErrors" from="[]"/>
            <set field="variantProductIds" from="[]"/>

            <!-- Iterate the productVariants list -->
            <iterate list="productVariants" entry="productVariant">
                <!-- For each product variant call the create#ProductVariant service -->
                <script>
                    <![CDATA[
                        actionResult = ec.service.sync().name("co.hotwax.orderledger.product.ProductServices.create#ProductVariant")
                        .parameters([productVariantJson:productVariant,parentProductId:parentProductId])
                        .requireNewTransaction(true)
                        .call()

                        // If any errors then add the error to variantErrors list
                        if (ec.message.hasError()) {
                            variantErrors.add(ec.message.getErrorsString())
                        }
                        ec.message.clearAll();
                    ]]>
                </script>
                <if condition="actionResult.productId">
                    <set field="variantProductIds" from="variantProductIds + actionResult.productId"/>
                </if>
            </iterate>
            <if condition="variantProductIds">
                <entity-find entity-name="org.apache.ofbiz.product.product.ProductAssoc" list="productAssocs">
                    <econdition field-name="productId" from="parentProductId"/>
                    <econdition field-name="productIdTo" operator="not-in" from="variantProductIds"/>
                </entity-find>
                <if condition="productAssocs">
                    <iterate list="productAssocs" entry="productAssoc">
                        <service-call name="delete#org.apache.ofbiz.product.product.ProductAssoc" in-map="productAssoc" transaction="force-new" ignore-error="true"/>
                    </iterate>
                </if>
            </if>

            <service-call name="co.hotwax.oms.search.SearchServices.call#CreateProductIndex" in-map="[productId:parentProductId, indexVariants:true]" ignore-error="true"/>
            <log level="info" message="Created product index for oms productId : ${parentProductId}"/>

            <if condition="variantErrors">
                <script>
                    ec.message.addError(variantErrors.toString())
                </script>
            </if>
        </actions>
    </service>

    <service verb="create" noun="VirtualProduct">
        <description>Service to create virtual product and its shopify shop product record.</description>
        <in-parameters>
            <parameter name="productJson" type="Map" required="true">
                <description>Product json to create the virtual product.</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="productId">
                <description>The productId of the created virtual product.</description>
            </parameter>
        </out-parameters>
        <actions>

            <!-- Check if the product already exists -->
            <entity-find entity-name="org.apache.ofbiz.product.product.Product" list="productsList">
                <econdition field-name="internalName" from="productJson.internalName"/>
            </entity-find>

            <set field="productJson.productId" from="productsList?.first?.productId"/>

            <!-- Check if the productId is not null then only create ShopifyShopProduct record -->
            <if condition="productJson.productId">
                <!-- Create ShopifyShopProduct record -->
                <service-call name="store#co.hotwax.shopify.ShopifyShopProduct" in-map="[shopId:productJson.shopifyShopProduct.shopId,
                        productId:productJson.productId,shopifyProductId:productJson.shopifyShopProduct.shopifyProductId]"/>
                <set field="productId" from="productJson.productId"/>
                <return/>
            </if>

            <!-- Get the ShopifyShopProduct record and remove it from productJson -->
            <set field="shopifyShopProduct" from="productJson.remove('shopifyShopProduct')"/>

            <!-- Call prepare#ProductCreate service to get the json for creating product -->
            <service-call name="co.hotwax.orderledger.product.ProductServices.prepare#ProductCreate" in-map="[productJson:productJson]"
                          out-map="prepareProductCreateOut"/>

            <!-- Call create service for Virtual Product -->
            <service-call name="create#org.apache.ofbiz.product.product.Product" in-map="prepareProductCreateOut.productJson"
                    out-map="createProductOut"/>

            <!-- Set the parentProductId -->
            <set field="productId" from="createProductOut.productId"/>

            <!-- Create ShopifyShopProduct record -->
            <service-call name="store#co.hotwax.shopify.ShopifyShopProduct" in-map="[shopId:shopifyShopProduct.shopId,
                    productId:productId,shopifyProductId:shopifyShopProduct.shopifyProductId]" out-map="context"/>
        </actions>
    </service>

    <service verb="create" noun="ProductVariant">
        <description>Service to create Product Variant.</description>
        <in-parameters>
            <parameter name="productVariantJson" type="Map" required="true">
                <description>The product variant json to be created.</description>
            </parameter>
            <parameter name="parentProductId">
                <description>The parent product id for the variants.</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="productId"/>
        </out-parameters>
        <actions>

            <!-- Check if internalName is present, if no return as for variant the internalName is used to
                 uniquely identify the product and if missing then product should not be created. -->
            <if condition="!productVariantJson.internalName">
                <return error="true" message="Error for ShopifyProductId [${productVariantJson.shopifyShopProduct.shopifyProductId}], either Shopify Product Id or Shopify Product SKU or Barcode is required to create product."/>
            </if>

            <!-- Check if the product already exists -->
            <entity-find entity-name="org.apache.ofbiz.product.product.Product" list="productsList">
                <econdition field-name="internalName" from="productVariantJson.internalName"/>
            </entity-find>

            <!-- Set productId in the productVariantMap if the productId exists -->
            <set field="productVariantJson.productId" from="productsList?.first?.productId"/>

            <!-- Set the shopifyShopProductMap from productVariantJsonMap -->
            <set field="shopifyShopProduct" from="productVariantJson.remove('shopifyShopProduct')"/>

            <!-- Check if productId is not null -->
            <if condition="productVariantJson.productId">
                <set field="productId" from="productVariantJson.productId"/>
                <if condition="shopifyShopProduct"><then>
                    <!-- Create ShopifyShopProduct record -->
                    <service-call name="store#co.hotwax.shopify.ShopifyShopProduct" in-map="[shopId:shopifyShopProduct.shopId,
                            productId:productVariantJson.productId,shopifyProductId:shopifyShopProduct.shopifyProductId,
                            shopifyInventoryItemId:shopifyShopProduct.shopifyInventoryItemId]" out-map="context"/>
                </then><else>
                    <log message="Not creating Shopify Shop Product record as ShopifyShopProduct map is missing for [${productVariantJson.productId}]"/>
                </else>
                </if>
                <if condition="parentProductId"><then>
                    <!-- Identify if parent product and productVariantJson.productId are already associated in ProductAssoc entity-->
                    <entity-find entity-name="org.apache.ofbiz.product.product.ProductAssoc" list="productAssocs" limit="1">
                        <econdition field-name="productId" from="parentProductId"/>
                        <econdition field-name="productIdTo" from="productVariantJson.productId"/>
                        <econdition field-name="productAssocTypeId" value="PRODUCT_VARIANT"/>
                        <date-filter/>
                    </entity-find>
                    <!-- If not then create a new ProductAssoc record -->
                    <if condition="!productAssocs">
                        <service-call name="create#org.apache.ofbiz.product.product.ProductAssoc" in-map="[productIdTo:productVariantJson.productId, productId:parentProductId, productAssocTypeId:'PRODUCT_VARIANT', sequenceNum:productVariantJson.sequenceNum]"/>
                    </if>
                    <return/>
                </then>
                    <else>
                        <log level="warn" message="Not creating ProductAssoc record as the parentProductId is missing for [${productVariantJson.productId}]"/>
                    </else>
                </if>
            </if>

            <!-- Call prepare#ProductCreate for the productVariantJson map -->
            <service-call name="co.hotwax.orderledger.product.ProductServices.prepare#ProductCreate" in-map="[productJson:productVariantJson]"
                    out-map="prepareProductCreateOut"/>

            <!-- Create Product record for the variant product -->
            <service-call name="create#org.apache.ofbiz.product.product.Product" in-map="prepareProductCreateOut.productJson"
                    out-map="createProductOut"/>
            <set field="productId" from="createProductOut.productId"/>

            <if condition="parentProductId"><then>
                <!-- Create ProductAssoc record for the variant product -->
                <service-call name="create#org.apache.ofbiz.product.product.ProductAssoc" in-map="[productId:parentProductId,productIdTo:createProductOut.productId,productAssocTypeId:'PRODUCT_VARIANT', sequenceNum:productVariantJson.sequenceNum]"/>
            </then><else>
                <log level="warn" message="Not creating ProductAssoc record as the parentProductId is missing for [${createProductOut.productId}]"/>
            </else>
            </if>
            <if condition="shopifyShopProduct"><then>
                <!-- Create ShopifyShopProduct record for the variant product -->
                <service-call name="create#co.hotwax.shopify.ShopifyShopProduct" in-map="[shopId:shopifyShopProduct.shopId,
                        productId:createProductOut.productId,shopifyProductId:shopifyShopProduct.shopifyProductId,
                        shopifyInventoryItemId:shopifyShopProduct.shopifyInventoryItemId]" out-map="context"/>
            </then><else>
                <log message="Not creating Shopify Shop Product record as ShopifyShopProduct map is missing for [${createProductOut.productId}]"/>
            </else>
            </if>
        </actions>
    </service>

    <service verb="prepare" noun="ProductCreate">
        <description>Service to create the json map required for creating the product and its related records.</description>
        <in-parameters>
            <parameter name="productJson" type="Map" required="true">
                <description>The input json map for product.</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="productJson" type="Map">
                <description>The output json map for the product.</description>
            </parameter>
        </out-parameters>
        <actions>
            <!--<log message="productJson BEFORE prepare create: ${productJson}"/>-->
            <!-- Set the features list and remove it from productJson -->
            <set field="features" from="productJson.remove('features')"/>

            <!-- Check if features list is not null -->
            <if condition="features">
                <!-- Initialize the featureAppls list -->
                <set field="featureAppls" from="[]"/>

                <!-- Iterate through the features list -->
                <iterate list="features" entry="feature">
                    <!-- Fetch productFeatureType record for productFeatureTypeId -->
                    <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeatureType" list="productFeatureTypes">
                        <econdition field-name="description" from="feature.productFeatureTypeDesc.trim()"/>
                    </entity-find>

                    <if condition="productFeatureTypes">
                        <set field="productFeatureTypeId" from="productFeatureTypes[0].productFeatureTypeId"/>
                        <else>
                            <service-call name="create#org.apache.ofbiz.product.feature.ProductFeatureType" in-map="[description:feature.productFeatureTypeDesc.trim()]"
                                          out-map="createProductFeatureTypeOutput" transaction="force-new"/>
                            <set field="productFeatureTypeId" from="createProductFeatureTypeOutput.productFeatureTypeId"/>
                        </else>
                    </if>

                    <!-- Fetch feature record for the productFeatureId -->
                    <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeature" list="productFeatures">
                        <econdition field-name="description" from="feature.featureDesc.trim()"/>
                        <econdition field-name="productFeatureTypeId" from="productFeatureTypeId"/>
                    </entity-find>

                    <if condition="productFeatures">
                        <set field="productFeatureId" from="productFeatures[0].productFeatureId"/>
                        <else>
                            <service-call name="create#org.apache.ofbiz.product.feature.ProductFeature" in-map="[productFeatureTypeId:productFeatureTypeId, description:feature.featureDesc.trim()]"
                                          out-map="createProductFeatureOutput" transaction="force-new"/>
                            <set field="productFeatureId" from="createProductFeatureOutput.productFeatureId"/>
                        </else>
                    </if>

                    <set field="featureAppls" from="featureAppls + [productFeatureId:productFeatureId, productFeatureApplTypeId:feature.productFeatureApplTypeId, sequenceNum:feature.sequenceNum]"/>
                </iterate>
                <set field="productJson.featureAppls" from="featureAppls"/>
            </if>

            <!-- Set the goodIdentifications from the incoming productJson -->
            <if condition="productJson.goodIdentifications">
                <set field="productJson.identifications" from="productJson.remove('goodIdentifications')"/>
            </if>

            <!-- Set the product prices from the incoming productJson -->
            <if condition="productJson.productPrices">
                <set field="productJson.prices" from="productJson.remove('productPrices')"/>
            </if>

            <!-- Set the createdDate as nowDate for the product -->
            <set field="productJson.createdDate" from="ec.user.nowTimestamp"/>

            <!-- Adding log for testing -->
            <!--<log message="productJson AFTER prepare create: ${productJson}"/>-->
        </actions>
    </service>
    <service verb="update" noun="ProductAndVariants">
        <description>This service will update product and create new variants</description>
        <in-parameters>
            <parameter name="payload" type="Map" required="true"/>
        </in-parameters>
        <actions>
            <set field="productVariants" from="payload.remove('variants')"/>

            <!-- If the productId is null, then create a new product and create a new ShopifyShopProduct record-->
            <if condition="!payload.productId">

                <!-- Call create#VirtualProduct service -->
                <service-call name="co.hotwax.orderledger.product.ProductServices.create#VirtualProduct"
                        in-map="[productJson:payload]" out-map="createVirtualProductOut" transaction="force-new"/>

                <!-- Set the parentProductId returned from create#VirtualProduct service -->
                <set field="parentProductId" from="createVirtualProductOut.productId"/>
                <set field="existingParentProduct" from="false"/>
                <else>
                    <!-- Call update#VirtualProduct service -->
                    <service-call name="co.hotwax.orderledger.product.ProductServices.update#VirtualProduct"
                                  in-map="[productJson:payload]" out-map="updateVirtualProductOut" transaction="force-new"/>

                    <set field="existingParentProduct" from="true"/>
                    <set field="parentProductId" from="updateVirtualProductOut.productId"/>
                    <set field="parentProductUpdatedInfo" from="updateVirtualProductOut.updatedInfo"/>
                    <set field="parentProductKeywords" from="updateVirtualProductOut.keywords"/>
                    <set field="parentProductDeleteProductKeywords" from="updateVirtualProductOut.deleteProductKeywords"/>
                    <set field="parentProductFeatureAppls" from="updateVirtualProductOut.featureAppls"/>
                    <set field="parentProductDeleteFeatureAppls" from="updateVirtualProductOut.deleteProductFeatureAppls"/>
                </else>
            </if>

            <!-- Set the variantErrors list to store the errors occurred while creating variant product -->
            <set field="variantErrors" from="[]"/>
            <set field="variantProductIds" from="[]"/>
            <set field="variantProductFeatureAppls" from="[:]"/>
            <set field="variantProductDeleteFeatureAppls" from="[:]"/>
            <set field="variantProductIdentifications" from="[:]"/>
            <set field="variantProductPrices" from="[:]"/>
            <set field="variantProductAssocs" from="[:]"/>
            <set field="variantProductUpdatedInfo" from="[:]"/>
            <iterate list="productVariants" entry="productVariant">
                <script>
                    <![CDATA[
                        actionResult = ec.service.sync().name("co.hotwax.orderledger.product.ProductServices.update#ProductVariant")
                        .parameters([productVariantJson:productVariant,parentProductId:parentProductId])
                        .requireNewTransaction(true)
                        .call()

                        // If any errors then add the error to variantErrors list
                        if (ec.message.hasError()) {
                            variantErrors.add(ec.message.getErrorsString())
                        }
                        ec.message.clearAll();
                    ]]>
                </script>
                <if condition="actionResult.productId">
                    <set field="variantProductIds" from="variantProductIds + actionResult.productId"/>
                    <if condition="actionResult.featureAppls">
                        <set field="variantProductFeatureAppls[actionResult.productId]" from="actionResult.featureAppls"/>
                    </if>
                    <if condition="actionResult.deleteProductFeatureAppls">
                        <set field="variantProductDeleteFeatureAppls[actionResult.productId]" from="actionResult.deleteProductFeatureAppls"/>
                    </if>
                    <if condition="actionResult.identifications">
                        <set field="variantProductIdentifications[actionResult.productId]" from="actionResult.identifications"/>
                    </if>
                    <if condition="actionResult.prices">
                        <set field="variantProductPrices[actionResult.productId]" from="actionResult.prices"/>
                    </if>
                    <if condition="actionResult.assocs">
                        <set field="variantProductAssocs[actionResult.productId]" from="actionResult.assocs"/>
                    </if>
                    <if condition="actionResult.updatedInfo">
                        <set field="variantProductUpdatedInfo[actionResult.productId]" from="actionResult.updatedInfo"/>
                    </if>
                </if>
            </iterate>
            <if condition="variantProductIds">
                <entity-find entity-name="org.apache.ofbiz.product.product.ProductAssoc" list="productAssocs">
                    <econdition field-name="productId" from="parentProductId"/>
                    <econdition field-name="productIdTo" operator="not-in" from="variantProductIds"/>
                </entity-find>
                <if condition="productAssocs">
                    <iterate list="productAssocs" entry="productAssoc">
                        <service-call name="delete#org.apache.ofbiz.product.product.ProductAssoc" in-map="productAssoc" transaction="force-new" ignore-error="true"/>
                    </iterate>
                </if>
            </if>
            <set field="isVirtualUpdated" from="parentProductKeywords || parentProductFeatureAppls || parentProductDeleteProductKeywords || parentProductDeleteFeatureAppls || parentProductUpdatedInfo"/>
            <set field="anyVariantUpdated" from="variantProductFeatureAppls || variantProductDeleteFeatureAppls || variantProductIdentifications || variantProductPrices || variantProductAssocs || variantProductUpdatedInfo"/>
            <set field="indexVariants" from="anyVariantUpdated"/>
            <if condition="!existingParentProduct">
                <set field="isVirtualUpdated" from="true"/>
            </if>

            <if condition="isVirtualUpdated || anyVariantUpdated">
                <service-call name="co.hotwax.oms.search.SearchServices.call#CreateProductIndex" in-map="[productId:parentProductId, indexVariants:indexVariants]" ignore-error="true" transaction="force-new"/>
                <log level="info" message="Created product index for oms productId : ${parentProductId}"/>
            </if>

            <if condition="variantErrors">
                <script>
                    ec.message.addError(variantErrors.toString())
                </script>
            </if>
        </actions>
    </service>

    <service verb="prepare" noun="ProductUpdate">
        <in-parameters>
            <parameter name="productJson" type="Map" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="productJson" type="Map" required="true"/>
            <parameter name="deleteProductFeatureAppls" type="List"/>
            <parameter name="deleteProductKeywords" type="List"/>
            <parameter name="updatedInfo" type="Map"/>
        </out-parameters>
        <actions>
            <!--<log message="productJson BEFORE prepare update: ${productJson}"/>-->
            <!-- Prepare the map of updated Product level details -->
            <set field="selectedFields" from="['productName', 'productTypeId', 'detailImageUrl', 'productWeight', 'shippingWeight', 'isVirtual', 'isVariant']"/>
            <entity-find-one entity-name="org.apache.ofbiz.product.product.Product" value-field="product">
                <field-map field-name="productId" from="productJson.productId"/>
                <select-field field-name="productName,productTypeId,detailImageUrl,productWeight,shippingWeight,isVirtual,isVariant"/>
            </entity-find-one>
            <set field="updatedInfo" from="productJson.findAll { k, v -> k in selectedFields &amp;&amp; v != null &amp;&amp; v != product[k]}"/>
            <!-- Prepare the product features -->
            <set field="features" from="productJson.remove('features')"/>
            <set field="validFeatureAppls" from="[]"/>
            <if condition="features">
                <!-- Initialize the featureAppls list -->
                <set field="featureAppls" from="[]"/>

                <!-- Iterate through the features list -->
                <iterate list="features" entry="feature">
                    <!-- Fetch productFeatureType record for productFeatureTypeId -->
                    <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeatureType" list="productFeatureTypes">
                        <econdition field-name="description" from="feature.productFeatureTypeDesc.trim()"/>
                    </entity-find>

                    <if condition="productFeatureTypes">
                        <set field="productFeatureTypeId" from="productFeatureTypes[0].productFeatureTypeId"/>
                        <else>
                            <service-call name="create#org.apache.ofbiz.product.feature.ProductFeatureType" in-map="[description:feature.productFeatureTypeDesc.trim()]"
                                    out-map="createProductFeatureTypeOutput" transaction="force-new"/>
                            <set field="productFeatureTypeId" from="createProductFeatureTypeOutput.productFeatureTypeId"/>
                        </else>
                    </if>

                    <!-- Fetch feature record for the productFeatureId -->
                    <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeature" list="productFeatures">
                        <econdition field-name="description" from="feature.featureDesc.trim()"/>
                        <econdition field-name="productFeatureTypeId" from="productFeatureTypeId"/>
                    </entity-find>

                    <if condition="productFeatures">
                        <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeatureAppl" list="productFeatureAppls" limit="1">
                            <econdition field-name="productId" from="productJson.productId"/>
                            <econdition field-name="productFeatureId" from="productFeatures[0].productFeatureId"/>
                            <econdition field-name="productFeatureApplTypeId" from="feature.productFeatureApplTypeId"/>
                            <date-filter/>
                        </entity-find>
                        <if condition="productFeatureAppls">
                            <set field="validFeatureAppls" from="validFeatureAppls + productFeatureAppls[0]"/>
                            <else>
                                <set field="featureAppls" from="featureAppls + [productFeatureId:productFeatures[0].productFeatureId, productFeatureApplTypeId:feature.productFeatureApplTypeId, sequenceNum:feature.sequenceNum]"/>
                            </else>
                        </if>
                        <else>
                            <service-call name="create#org.apache.ofbiz.product.feature.ProductFeature" in-map="[productFeatureTypeId:productFeatureTypeId, description:feature.featureDesc.trim()]"
                                    out-map="createProductFeatureOutput" transaction="force-new"/>
                            <set field="featureAppls" from="featureAppls + [productFeatureId:createProductFeatureOutput.productFeatureId, productFeatureApplTypeId:feature.productFeatureApplTypeId, sequenceNum:feature.sequenceNum]"/>
                        </else>
                    </if>
                </iterate>
                <if condition="featureAppls">
                    <set field="productJson.featureAppls" from="featureAppls"/>
                </if>
            </if>

            <!-- TODO: Add more comments -->
            <!-- Get the current active ProductFeatureAppl list for the product -->
            <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeatureAppl" list="currentProductFeatureAppls">
                <econdition field-name="productId" from="productJson.productId"/>
                <date-filter/>
            </entity-find>
            <set field="deleteProductFeatureAppls" from="[]"/>
            <iterate list="currentProductFeatureAppls" entry="currentProductFeatureAppl">
                <set field="toBeDeleted" value="true" type="Boolean"/>
                <iterate list="validFeatureAppls" entry="validFeatureAppl">
                    <if condition="currentProductFeatureAppl.productFeatureId == validFeatureAppl.productFeatureId">
                        <set field="toBeDeleted" value="false" type="Boolean"/>
                    </if>
                </iterate>
                <if condition="toBeDeleted">
                    <set field="deleteProductFeatureAppls" from="deleteProductFeatureAppls + currentProductFeatureAppl"/>
                </if>
            </iterate>

            <set field="keywords" from="productJson.remove('keywords')"/>
            <set field="validKeywords" from="[]"/>
            <if condition="keywords">
                <set field="keywordsToAdd" from="[]"/>
                <iterate list="keywords" entry="keyword">
                    <entity-find-one entity-name="org.apache.ofbiz.product.product.ProductKeyword" value-field="productKeyword">
                        <field-map field-name="productId" from="productJson.productId"/>
                        <field-map field-name="keywordTypeId" from="keyword.keywordTypeId"/>
                        <field-map field-name="keyword" from="keyword.keyword"/>
                    </entity-find-one>
                    <if condition="productKeyword">
                        <set field="validKeywords" from="validKeywords + productKeyword"/>
                        <else>
                            <set field="keywordsToAdd" from="keywordsToAdd + keyword"/>
                        </else>
                    </if>
                </iterate>
                <if condition="keywordsToAdd">
                    <set field="productJson.keywords" from="keywordsToAdd"/>
                </if>
            </if>

            <!-- Fetch the current Product Keywords for the productId -->
            <entity-find entity-name="org.apache.ofbiz.product.product.ProductKeyword" list="currentProductKeywords">
                <econdition field-name="productId" from="productJson.productId"/>
            </entity-find>
            <!-- Initialize the deleteProductKeywords list -->
            <set field="deleteProductKeywords" from="[]"/>
            <!-- Iterate the currentProductKeywords list -->
            <iterate list="currentProductKeywords" entry="currentProductKeyword">
                <!-- Initialize toBeDeleted to true -->
                <set field="toBeDeleted" value="true" type="Boolean"/>
                <!-- Iterate the keywords list in the productJson -->
                <iterate list="validKeywords" entry="validKeyword">
                    <if condition="currentProductKeyword.keyword == validKeyword.keyword">
                        <set field="toBeDeleted" value="false" type="Boolean"/>
                    </if>
                </iterate>
                <!-- If toBeDeleted is true then add that keyword map to the deleteProductKeywords list -->
                <if condition="toBeDeleted">
                    <set field="deleteProductKeywords" from="deleteProductKeywords + currentProductKeyword"/>
                </if>
            </iterate>

            <!-- Set the identifications list -->
            <set field="productJson.identifications" from="[]"/>

            <!-- Set the goodIdentifications from the incoming productJson -->
            <set field="goodIdentifications" from="productJson.remove('goodIdentifications')"/>

            <!-- If goodIdentifications then iterate the goodIdentifications list and check in GoodIdentification entity
                 if the goodIdentificationType is already present -->
            <if condition="goodIdentifications">
                <iterate list="goodIdentifications" entry="goodIdentification">

                    <!-- Fetch the goodIdentifications for the productId -->
                    <entity-find entity-name="org.apache.ofbiz.product.product.GoodIdentification" list="goodIdentificationList">
                        <econdition field-name="productId" from="productJson?.productId"/>
                        <econdition field-name="goodIdentificationTypeId" from="goodIdentification.goodIdentificationTypeId"/>
                        <date-filter/>
                    </entity-find>

                    <!-- If goodIdentifications list and identification is updated then set the values from the list if not then set the values from the incoming goodIdentifications -->
                    <if condition="goodIdentificationList"><then>
                        <if condition="!goodIdentificationList[0].idValue.equals(goodIdentification.idValue)">
                            <set field="identification" from="[goodIdentificationTypeId:goodIdentificationList[0].goodIdentificationTypeId,
                             idValue:goodIdentification.idValue, fromDate:ec.l10n.format(goodIdentificationList[0].fromDate, 'yyyy-MM-dd HH:mm:ss.SSS')]"/>
                        </if>
                    </then>
                        <else>
                            <set field="identification" from="[goodIdentificationTypeId:goodIdentification.goodIdentificationTypeId,
                                 idValue:goodIdentification.idValue]"/>
                        </else>
                    </if>

                    <set field="productJson.identifications" from="productJson.identifications+(identification ?: [])"/>
                </iterate>
            </if>

            <!-- Set the productPrices map from the incoming productJson -->
            <set field="productPrices" from="productJson.remove('productPrices')"/>

            <!-- If productPrices then check in ProductPrice entity if the product price record is already present -->
            <if condition="productPrices">

                <!-- Fetch the productPrice for the product -->
                <entity-find entity-name="org.apache.ofbiz.product.price.ProductPrice" list="productPriceList">
                    <econdition field-name="productId" from="productJson?.productId"/>
                    <econdition field-name="productPriceTypeId" value="LIST_PRICE"/>
                    <econdition field-name="productPricePurposeId" value="PURCHASE"/>
                    <econdition field-name="currencyUomId" from="productPrices.currencyUomId"/>
                    <econdition field-name="productStoreGroupId" from="productPrices.productStoreGroupId"/>
                    <date-filter/>
                </entity-find>

                <!-- If productPriceList and price is updated then set the values from the list if not then set the values from the incoming productPrices -->
                <if condition="productPriceList"><then>
                    <if condition="productPriceList[0].price.compareTo(new BigDecimal(productPrices.price)) != 0">
                        <set field="productJson.prices" from="[productPriceTypeId:'LIST_PRICE', productPricePurposeId:'PURCHASE',
                        currencyUomId:productPrices.currencyUomId, price:productPrices.price, productStoreGroupId:productPrices.productStoreGroupId,
                        fromDate:ec.l10n.format(productPriceList[0].fromDate, 'yyyy-MM-dd HH:mm:ss.SSS')]"/>
                    </if>
                </then><else>
                    <set field="productJson.prices" from="productPrices"/>
                </else>
                </if>
            </if>
            <!--<log message="productJson AFTER prepare update: ${productJson}"/>-->
        </actions>
    </service>

    <service verb="update" noun="VirtualProduct">
        <in-parameters>
            <parameter name="productJson" type="Map" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="productId"/>
            <parameter name="keywords"/>
            <parameter name="featureAppls"/>
            <parameter name="deleteProductKeywords"/>
            <parameter name="deleteProductFeatureAppls"/>
            <parameter name="updatedInfo"/>
        </out-parameters>
        <actions>

            <!-- Set the shopifyShopProduct record form the productJson -->
            <set field="shopifyShopProduct" from="productJson.remove('shopifyShopProduct')"/>

            <!-- If the productId is not null, then update the product and ShopifyShopProduct record-->
            <service-call name="co.hotwax.orderledger.product.ProductServices.prepare#ProductUpdate" in-map="[productJson:productJson]" out-map="prepareProductUpdateOutput"/>
            <set field="deleteProductFeatureAppls" from="prepareProductUpdateOutput.remove('deleteProductFeatureAppls')"/>
            <set field="deleteProductKeywords" from="prepareProductUpdateOutput.remove('deleteProductKeywords')"/>
            <set field="keywords" from="prepareProductUpdateOutput.productJson.keywords"/>
            <set field="featureAppls" from="prepareProductUpdateOutput.productJson.featureAppls"/>
            <set field="updatedInfo" from="prepareProductUpdateOutput.productJson.remove('updatedInfo')"/>
            <service-call name="update#org.apache.ofbiz.product.product.Product" in-map="prepareProductUpdateOutput.productJson" out-map="updateProductOutput"/>
            <set field="productId" from="productJson.productId"/>

            <!-- Create/update the ShopifyShopProduct record -->
            <service-call name="store#co.hotwax.shopify.ShopifyShopProduct" in-map="[shopId:shopifyShopProduct.shopId,
                    productId:productId,shopifyProductId:shopifyShopProduct.shopifyProductId]"/>

            <!-- If we have deleteProductFeatureAppls in the output, then delete each productFeatureAppl -->
            <if condition="deleteProductFeatureAppls">
                <iterate list="deleteProductFeatureAppls" entry="productFeatureAppl">
                    <service-call name="delete#org.apache.ofbiz.product.feature.ProductFeatureAppl" in-map="productFeatureAppl"/>
                </iterate>
            </if>
            <if condition="deleteProductKeywords">
                <iterate list="deleteProductKeywords" entry="productKeyword">
                    <service-call name="delete#org.apache.ofbiz.product.product.ProductKeyword" in-map="productKeyword"/>
                </iterate>
            </if>
        </actions>
    </service>

    <service verb="update" noun="ProductVariant">
        <description>This service will update a product variant</description>
        <in-parameters>
            <parameter name="productVariantJson" type="Map" required="true">
                <description>The product variant json to be updated.</description>
            </parameter>
            <parameter name="parentProductId">
                <description>The parent product id for the variants.</description>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="productId"/>
            <parameter name="updatedInfo"/>
            <parameter name="featureAppls"/>
            <parameter name="deleteProductFeatureAppls"/>
            <parameter name="identifications"/>
            <parameter name="prices"/>
            <parameter name="assocs"/>
        </out-parameters>
        <actions>

            <!-- Check if internalName is present, if no return as for variant the internalName is used to
                 uniquely identify the product and if missing then product should not be created. -->
            <if condition="!productVariantJson.internalName">
                <return error="true" message="Error for ShopifyProductId [${productVariantJson.shopifyShopProduct.shopifyProductId}], either Shopify Product Id or Shopify Product SKU or Barcode is required to create product."/>
            </if>

            <!-- Check if the product already exists -->
            <entity-find entity-name="org.apache.ofbiz.product.product.Product" list="productsList">
                <econdition field-name="internalName" from="productVariantJson.internalName"/>
            </entity-find>

            <!-- Set productId in the productVariantMap if the productId exists -->
            <set field="productVariantJson.productId" from="productsList?.first?.productId"/>

            <!-- Set the shopifyShopProduct record from the productJson -->
            <set field="shopifyShopProduct" from="productVariantJson.remove('shopifyShopProduct')"/>

            <if condition="!productVariantJson.productId">
                <service-call name="co.hotwax.orderledger.product.ProductServices.prepare#ProductCreate" in-map="[productJson:productVariantJson]" out-map="prepareProductCreateOutput"/>
                <service-call name="create#org.apache.ofbiz.product.product.Product" in-map="prepareProductCreateOutput.productJson" out-map="createProductOutput"/>
                <set field="productId" from="createProductOutput.productId"/>
                <if condition="parentProductId"><then>
                    <service-call name="create#org.apache.ofbiz.product.product.ProductAssoc" in-map="[productIdTo:createProductOutput.productId, productId:parentProductId, productAssocTypeId:'PRODUCT_VARIANT', sequenceNum:productVariantJson.sequenceNum]"/>
                </then><else>
                    <log level="warn" message="Not creating ProductAssoc record as the parentProductId is missing for [${createProductOutput.productId}]"/>
                </else>
                </if>
                <if condition="shopifyShopProduct"><then>
                    <service-call name="store#co.hotwax.shopify.ShopifyShopProduct" in-map="[productId:createProductOutput.productId, shopId:shopifyShopProduct.shopId, shopifyProductId:shopifyShopProduct.shopifyProductId, shopifyInventoryItemId:shopifyShopProduct.shopifyInventoryItemId]"/>
                    <set field="assocs" from="[productIdTo:createProductOutput.productId, productId:parentProductId, productAssocTypeId:'PRODUCT_VARIANT', sequenceNum:productVariantJson.sequenceNum]"/>
                </then><else>
                    <log level="warn" message="Not creating Shopify Shop Product record as ShopifyShopProduct map is missing for [${createProductOutput.productId}]"/>
                </else>
                </if>
                <set field="updatedInfo" from="createProductOutput"/>
                <else>
                    <service-call name="co.hotwax.orderledger.product.ProductServices.prepare#ProductUpdate" in-map="[productJson:productVariantJson]" out-map="prepareProductUpdateOutput"/>
                    <set field="deleteProductFeatureAppls" from="prepareProductUpdateOutput.remove('deleteProductFeatureAppls')"/>
                    <set field="identifications" from="prepareProductUpdateOutput.productJson.identifications"/>
                    <set field="prices" from="prepareProductUpdateOutput.productJson.prices"/>
                    <service-call name="update#org.apache.ofbiz.product.product.Product" in-map="prepareProductUpdateOutput.productJson" out-map="updateProductOutput"/>
                    <set field="productId" from="productVariantJson.productId"/>

                    <if condition="parentProductId"><then>
                        <!-- Identify if parent product and productVariantJson.productId are already associated in ProductAssoc entity-->
                        <entity-find entity-name="org.apache.ofbiz.product.product.ProductAssoc" list="productAssocs" limit="1">
                            <econdition field-name="productId" from="parentProductId"/>
                            <econdition field-name="productIdTo" from="productVariantJson.productId"/>
                            <econdition field-name="productAssocTypeId" value="PRODUCT_VARIANT"/>
                            <date-filter/>
                        </entity-find>
                        <!-- If not then create a new ProductAssoc record -->
                        <if condition="!productAssocs">
                            <then>
                            <service-call name="create#org.apache.ofbiz.product.product.ProductAssoc" in-map="[productIdTo:productVariantJson.productId, productId:parentProductId, productAssocTypeId:'PRODUCT_VARIANT', sequenceNum:productVariantJson.sequenceNum]"/>
                            <set field="assocs" from="[productIdTo:productVariantJson.productId, productId:parentProductId, productAssocTypeId:'PRODUCT_VARIANT', sequenceNum:productVariantJson.sequenceNum]"/>
                            </then>
                            <else>
                                <service-call name="update#org.apache.ofbiz.product.product.ProductAssoc" in-map="[productIdTo:productVariantJson.productId, productId:parentProductId, productAssocTypeId:'PRODUCT_VARIANT', fromDate:productAssocs.first?.fromDate,sequenceNum:productVariantJson.sequenceNum]"/>
                                <set field="assocs" from="[productIdTo:productVariantJson.productId, productId:parentProductId, productAssocTypeId:'PRODUCT_VARIANT', sequenceNum:productVariantJson.sequenceNum]"/>
                            </else>
                        </if>
                    </then><else>
                        <log level="warn" message="Not creating ProductAssoc record as the parentProductId is missing for [${productVariantJson.productId}]"/>
                    </else>
                    </if>
                    <if condition="shopifyShopProduct"><then>
                        <service-call name="store#co.hotwax.shopify.ShopifyShopProduct" in-map="[productId:productVariantJson.productId, shopId:shopifyShopProduct.shopId, shopifyProductId:shopifyShopProduct.shopifyProductId,shopifyInventoryItemId:shopifyShopProduct.shopifyInventoryItemId]"/>
                    </then><else>
                        <log level="warn" message="Not creating Shopify Shop Product record as ShopifyShopProduct map is missing for [${productVariantJson.productId}]"/>
                    </else>
                    </if>
                    <!-- If we have deleteProductFeatureAppls in the output, then delete each productFeatureAppl -->
                    <if condition="deleteProductFeatureAppls">
                        <iterate list="deleteProductFeatureAppls" entry="productFeatureAppl">
                            <service-call name="delete#org.apache.ofbiz.product.feature.ProductFeatureAppl" in-map="productFeatureAppl"/>
                        </iterate>
                    </if>
                </else>
            </if>
        </actions>
    </service>
    <service verb="update" noun="ExternalProductVariant">
        <description>Updates an existing variant product from variant JSON input and creates related features and identifiers.</description>
        <implements service="org.moqui.impl.SystemMessageServices.consume#SystemMessage"/>
        <out-parameters>
            <parameter name="productId" type="String"/>
        </out-parameters>
        <actions>
            <!-- Fetch SystemMessage -->
            <entity-find-one entity-name="moqui.service.message.SystemMessage" value-field="systemMessage"/>

            <!-- Parse messageText as productVariantJson -->
            <set field="productVariantJson" from="org.moqui.impl.context.ContextJavaUtil.jacksonMapper.readValue(systemMessage.messageText, Map.class)"/>

            <!-- Fetch SystemMessageRemote to get shopId -->
            <entity-find-one entity-name="moqui.service.message.SystemMessageRemote" value-field="systemMessageRemote">
                <field-map field-name="systemMessageRemoteId" from="systemMessage.systemMessageRemoteId"/>
            </entity-find-one>

            <set field="shopId" from="systemMessageRemote.internalId"/>

            <!-- Fetch existing product by UPCA -->
            <entity-find-one entity-name="org.apache.ofbiz.product.product.Product" value-field="existingProduct">
                <field-map field-name="internalName" from="productVariantJson.barcode"/>
            </entity-find-one>

            <if condition="!existingProduct">
                <return error="true" message="Product with UPCA [${productVariantJson.barcode}] does not exist."/>
            </if>

            <entity-find-one entity-name="co.hotwax.shopify.ShopifyShop" value-field="shopifyShop"/>
            <!-- Update product fields -->
            <set field="updateProductMap" from="[:]"/>
            <set field="updateProductMap.productId" from="existingProduct.productId"/>
            <set field="updateProductMap.productName" from="productVariantJson.title"/>
            <set field="updateProductMap.productWeight" from="productVariantJson.weight ?: 1"/>
            <set field="updateProductMap.shippingWeight" from="productVariantJson.weight ?: 1"/>
            <set field="updateProductMap.inventoryItemTypeId" value="NON_SERIAL_INV_ITEM"/>
            <service-call name="update#org.apache.ofbiz.product.product.Product" in-map="updateProductMap" transaction="force-new"/>

            <set field="productId" from="existingProduct.productId"/>

            <!-- Fetch GoodIdentification records for the product to check if already exists -->
            <entity-find entity-name="org.apache.ofbiz.product.product.GoodIdentification" list="goodIdentifications">
                <econdition field-name="productId"/>
                <date-filter/>
            </entity-find>
            <!-- Insert GoodIdentification for Barcode -->
            <if condition="productVariantJson.barcode">
                <set field="goodIdentification" from="goodIdentifications.find { it.goodIdentificationTypeId == 'UPCA' }"/>
                <if condition="goodIdentification">
                    <service-call name="update#org.apache.ofbiz.product.product.GoodIdentification"
                                  in-map="[productId: productId, goodIdentificationTypeId: 'UPCA', idValue: goodIdentification.idValue,
                    thruDate: ec.user.nowTimestamp]"/>
                </if>
                <service-call name="store#org.apache.ofbiz.product.product.GoodIdentification"
                              in-map="[productId: productId, goodIdentificationTypeId: 'UPCA', idValue: productVariantJson.barcode]"
                              transaction="force-new"/>
            </if>

            <!-- Insert GoodIdentification for SKU -->
            <if condition="productVariantJson.sku">
                <set field="goodIdentification" from="goodIdentifications.find { it.goodIdentificationTypeId == 'SKU' }"/>
                <if condition="goodIdentification">
                    <service-call name="update#org.apache.ofbiz.product.product.GoodIdentification"
                                  in-map="[productId: productId, goodIdentificationTypeId: 'SKU', idValue: goodIdentification.idValue,
                    thruDate: ec.user.nowTimestamp]"/>
                </if>
                <service-call name="store#org.apache.ofbiz.product.product.GoodIdentification"
                              in-map="[productId: productId, goodIdentificationTypeId: 'SKU', idValue: productVariantJson.sku]"
                              transaction="force-new"/>
                <else>
                    <return error="true" message="Primary Identifier UPCA is missing."/>
                </else>
            </if>

            <!-- Insert GoodIdentification for ERP_ID -->
            <if condition="productVariantJson.ERP_ID">
                <set field="goodIdentification" from="goodIdentifications.find { it.goodIdentificationTypeId == 'ERP_ID' }"/>
                <if condition="goodIdentification">
                    <service-call name="update#org.apache.ofbiz.product.product.GoodIdentification"
                                  in-map="[productId: productId, goodIdentificationTypeId: 'ERP_ID', idValue: goodIdentification.idValue,
                    thruDate: ec.user.nowTimestamp]"/>
                </if>
                <service-call name="store#org.apache.ofbiz.product.product.GoodIdentification"
                              in-map="[productId: productId, goodIdentificationTypeId: 'ERP_ID', idValue: productVariantJson.ERP_ID]"
                              transaction="force-new"/>
            </if>

            <!-- Insert variant options as ProductFeature if provided -->
            <if condition="productVariantJson.selectedOptions">
                <iterate list="productVariantJson.selectedOptions" entry="selectedOption">
                    <set field="productFeatureTypeDesc" from="selectedOption.name"/>
                    <set field="featureDesc" from="selectedOption.value"/>

                    <!-- Fetch or create ProductFeatureType -->
                    <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeatureType" list="productFeatureTypes">
                        <econdition field-name="description" from="productFeatureTypeDesc"/>
                    </entity-find>
                    <if condition="productFeatureTypes">
                        <set field="productFeatureTypeId" from="productFeatureTypes[0].productFeatureTypeId"/>
                        <else>
                            <service-call name="create#org.apache.ofbiz.product.feature.ProductFeatureType"
                                          out-map="createdFeatureType"
                                          in-map="[description: productFeatureTypeDesc]"
                                          transaction="force-new"/>
                            <set field="productFeatureTypeId" from="createdFeatureType.productFeatureTypeId"/>
                        </else>
                    </if>

                    <!-- Fetch or create ProductFeature -->
                    <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeature" list="productFeatures">
                        <econdition field-name="description" from="featureDesc"/>
                        <econdition field-name="productFeatureTypeId" from="productFeatureTypeId"/>
                    </entity-find>
                    <if condition="productFeatures">
                        <set field="productFeatureId" from="productFeatures[0].productFeatureId"/>
                        <else>
                            <service-call name="create#org.apache.ofbiz.product.feature.ProductFeature"
                                          out-map="createdFeature"
                                          in-map="[productFeatureTypeId: productFeatureTypeId, description: featureDesc]"
                                          transaction="force-new"/>
                            <set field="productFeatureId" from="createdFeature.productFeatureId"/>
                        </else>
                    </if>

                    <!-- Create ProductFeatureAppl, if doesn't exist already -->
                    <entity-find entity-name="org.apache.ofbiz.product.feature.ProductFeatureAppl" list="existingFeatureAppls" limit="1">
                        <econdition field-name="productId" from="productId"/>
                        <econdition field-name="productFeatureId" from="productFeatureId"/>
                        <econdition field-name="productFeatureApplTypeId" value="STANDARD_FEATURE"/>
                        <date-filter/>
                    </entity-find>
                    <if condition="!existingFeatureAppls">
                        <service-call name="create#org.apache.ofbiz.product.feature.ProductFeatureAppl"
                                      in-map="[productId: productId, productFeatureId: productFeatureId, productFeatureApplTypeId: 'STANDARD_FEATURE']"
                                      transaction="force-new"/>
                    </if>
                </iterate>
            </if>

            <!-- Insert product price -->
            <if condition="productVariantJson.price">
                <entity-find entity-name="org.apache.ofbiz.product.store.ProductStore" list="productStores">
                    <econdition field-name="productStoreId" from="shopifyShop.productStoreId"/>
                </entity-find>
                <service-call name="create#org.apache.ofbiz.product.price.ProductPrice"
                              in-map="[productId: productId, productPriceTypeId: 'LIST_PRICE', productPricePurposeId: 'PURCHASE',
                        currencyUomId: productStores[0].defaultCurrencyUomId,
                        productStoreGroupId: productStores[0].primaryStoreGroupId,
                        price: productVariantJson.price, fromDate: ec.user.nowTimestamp]"
                              transaction="force-new"/>
            </if>

            <!-- Index product -->
            <service-call name="co.hotwax.oms.search.SearchServices.call#CreateProductIndex"
                          in-map="[productId: productId, indexVariants: false]" ignore-error="true" transaction="force-new"/>
            <log level="info" message="Updated and indexed product: ${productId}"/>
        </actions>
    </service>
</services>