<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="dispatch" noun="WebhookEvent" authenticate="false">
        <description>
            Dispatcher for business events. Finds all subscribers and sends events.
        </description>
        <in-parameters>
            <parameter name="topicEnumId" required="true"/>
            <parameter name="orderId"/>
            <parameter name="orderItemSeqId"/>
            <parameter name="shipmentId"/>
            <parameter name="facilityId"/>
            <parameter name="eventContext" type="Map"/>
        </in-parameters>
        <actions>

            <set field="nowDate" from="ec.user.nowTimestamp"/>
            <log level="warn" message=">>> [WebhookServices] dispatch#WebhookEvent called with topic=${topicEnumId}, orderId=${orderId}, shipmentId=${shipmentId}, eventContext=${eventContext}"/>

            <entity-find entity-name="co.hotwax.common.WebhookConfig" list="subscribers">
                <econdition field-name="topicEnumId" from="topicEnumId"/>
            </entity-find>

            <if condition="!subscribers">
                <log level="warn" message=">>> [WebhookServices] No subscribers found for topic ${topicEnumId}. Exiting."/>
                <return/>
            </if>

            <if condition="!orderId &amp;&amp; shipmentId">
                <entity-find entity-name="org.apache.ofbiz.order.order.OrderShipment" list="orderShipments" limit="1">
                    <econdition field-name="shipmentId" from="shipmentId"/>
                </entity-find>
                <set field="orderId" from="orderShipments?.first?.orderId"/>
            </if>

            <set field="payload" from="eventContext?.payload"/>

            <if condition="!payload">
                <log level="warn" message=">>> [WebhookServices] Missing payload in eventContext for topic ${topicEnumId}, orderId=${orderId}, shipmentId=${shipmentId}. Exiting."/>
                <return/>
            </if>
            <!-- fallback/global secret for test/back-compat -->
            <set field="globalHmacHeaderName" from="'X-Hmac-SHA256'"/>

            <iterate list="subscribers" entry="subscriber">
                <if condition="subscriber.remoteUrl">
                    <entity-find-one entity-name="moqui.service.message.SystemMessageType" value-field="messageType">
                        <field-map field-name="systemMessageTypeId" value="WebhookNotification"/>
                    </entity-find-one>
                    <if condition="!messageType">
                        <log level="error" message=">>> [WebhookServices] Missing SystemMessageType WebhookNotification. Skipping subscriber ${subscriber.webhookConfigId}."/>
                    <else>
                    <!-- 1. Prefer subscriber-level shared secret-->
                    <set field="hmacSecret" from="subscriber.sharedSecret"/>
                    <set field="hmacHeaderName" from="globalHmacHeaderName"/>

                    <!-- 2. Build compact event id (18 chars) -->
                    <set field="eventSourceId" from="payload?.event_source_id ?: payload?.order_item_seq_id"/>
                    <if condition="eventSourceId">
                        <set field="eventIdSeed" from="topicEnumId + '|' + eventSourceId + '|' + subscriber.webhookConfigId"/>
                    <else>
                        <set field="eventIdSeed" from="topicEnumId + '|' + (orderId ?: shipmentId ?: 'NA') + '|' + subscriber.webhookConfigId + '|' + nowDate.time + '|' + java.lang.System.nanoTime()"/>
                    </else>
                    </if>
                    <script>
                        def digest = java.security.MessageDigest.getInstance("SHA-1")
                        def hashHex = digest.digest((eventIdSeed ?: "").getBytes("UTF-8")).encodeHex().toString()
                        // "EV" + 16 hex chars => 18 chars total
                        eventId = "EV" + hashHex.substring(0, 16)
                    </script>
                    <set field="payload.event_id" from="eventId"/>
                    <set field="payload.occurred_at" from="nowDate.toString()"/>


                    <!-- 3. De-dup by (SystemMessageType, eventId) -->
                    <entity-find-one entity-name="moqui.service.message.SystemMessage" value-field="existingSmsg">
                        <field-map field-name="systemMessageTypeId" value="WebhookNotification"/>
                        <field-map field-name="remoteMessageId" from="eventId"/>
                    </entity-find-one>
                    <if condition="existingSmsg">
                        <log level="info" message=">>> [WebhookServices] duplicate webhook skipped topic=${topicEnumId}, orderId=${orderId}, shipmentId=${shipmentId}, eventId=${eventId}, existingSystemMessageId=${existingSmsg.systemMessageId}"/>
                        <continue/>
                    </if>

                    <set field="messageText" from="org.moqui.impl.context.ContextJavaUtil.jacksonMapper.writeValueAsString(payload)"/>

                    <!-- 4. Create SystemMessage for audit and status tracking -->
                    <service-call name="create#moqui.service.message.SystemMessage" out-map="createSmsgOut"
                                  in-map="[systemMessageTypeId: 'WebhookNotification',
                                           messageText: messageText, remoteMessageId: eventId, statusId: 'SmsgProduced',
                                           docControl: (orderId ?: shipmentId)]"/>

                    <!-- 5. Send synchronously to avoid async race where SystemMessage is still uncommitted -->
                    <service-call name="co.hotwax.webhook.WebhookServices.send#WebhookNotification" ignore-error="true"
                                  in-map="[systemMessageId: createSmsgOut.systemMessageId, remoteUrl: subscriber.remoteUrl,
                                           hmacSecret: hmacSecret, hmacHeaderName: hmacHeaderName]"/>
                    <log level="info" message=">>> [WebhookServices] queued webhook topic=${topicEnumId}, orderId=${orderId}, shipmentId=${shipmentId}, systemMessageId=${createSmsgOut.systemMessageId}, eventId=${eventId}, remoteUrl=${subscriber.remoteUrl}"/>
                    </else>
                    </if>
                </if>
            </iterate>
        </actions>
    </service>

    <service verb="send" noun="WebhookNotification" authenticate="false">
        <description>Sends event notification via HTTP POST with SystemMessage status tracking</description>
        <in-parameters>
            <parameter name="systemMessageId" required="true"/>
            <parameter name="remoteUrl" required="true"/>
            <parameter name="hmacSecret"/>
            <parameter name="hmacHeaderName" default-value="X-Hmac-SHA256"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="moqui.service.message.SystemMessage" value-field="systemMessage"/>
            <if condition="!systemMessage">
                <log level="warn" message=">>> [WebhookServices] send#WebhookNotification skipped, SystemMessage not found for systemMessageId=${systemMessageId}"/>
                <return/>
            </if>

            <if condition="systemMessage.statusId == 'SmsgSent'">
                <log level="info" message=">>> [WebhookServices] send#WebhookNotification skipped, already sent systemMessageId=${systemMessageId}"/>
                <return/>
            </if>
            <if condition="systemMessage.statusId != 'SmsgProduced' &amp;&amp; systemMessage.statusId != 'SmsgError'">
                <log level="warn" message=">>> [WebhookServices] send#WebhookNotification skipped, invalid current status ${systemMessage.statusId} for systemMessageId=${systemMessageId}"/>
                <return/>
            </if>

            <if condition="!hmacSecret">
                <log level="error" message=">>> [WebhookServices] send#WebhookNotification missing hmacSecret for systemMessageId=${systemMessageId}, remoteUrl=${remoteUrl}"/>
                <!-- Set to error from current status (should be SmsgProduced) -->
                <service-call name="update#moqui.service.message.SystemMessage"
                              in-map="[systemMessageId: systemMessageId, statusId: 'SmsgError']"/>
                <return/>
            </if>

            <!-- Mark as sending -->
            <service-call name="update#moqui.service.message.SystemMessage"
                          in-map="[systemMessageId: systemMessageId, statusId: 'SmsgSending']"/>

            <!-- Build HTTP request -->
            <set field="restClient" from="ec.service.rest().method('post').uri(remoteUrl)"/>
            <script>restClient.addHeader("Content-Type", "application/json")</script>
            <set field="messageBody" from="systemMessage.messageText ?: ''"/>
            <set field="webhookTopic" from="null"/>
            <set field="webhookOccurredAt" from="null"/>
            <script><![CDATA[
                try {
                    Map payloadMap = org.moqui.impl.context.ContextJavaUtil.jacksonMapper.readValue(messageBody, Map.class)
                    webhookTopic = payloadMap?.event_type
                    webhookOccurredAt = payloadMap?.occurred_at
                } catch (Exception ignored) {
                    // Keep optional metadata headers empty if payload can't be parsed.
                }
            ]]></script>
            <script><![CDATA[
                import javax.crypto.Mac
                import javax.crypto.spec.SecretKeySpec
                Mac hmacSha256 = Mac.getInstance("HmacSHA256")
                hmacSha256.init(new SecretKeySpec(hmacSecret.getBytes("UTF-8"), "HmacSHA256"))
                byte[] bytes = hmacSha256.doFinal(messageBody.getBytes("UTF-8"))
                webhookHmac = Base64.encoder.encodeToString(bytes)
            ]]></script>
            <script>restClient.addHeader(hmacHeaderName, webhookHmac)</script>
            <script>restClient.addHeader("X-Webhook-Id", systemMessage.remoteMessageId ?: systemMessageId)</script>
            <if condition="webhookTopic">
                <script>restClient.addHeader("X-Webhook-Topic", webhookTopic.toString())</script>
            </if>
            <if condition="webhookOccurredAt">
                <script>restClient.addHeader("X-Webhook-Occurred-At", webhookOccurredAt.toString())</script>
            </if>
            <script>restClient.addHeader("X-Webhook-Signature-Version", "v1")</script>
            <log level="info" message=">>> [WebhookServices] HMAC header added for systemMessageId=${systemMessageId}, header=${hmacHeaderName}"/>
            <script>restClient.text(messageBody)</script>

            <script>
                try {
                    def response = restClient.call()
                    // If we got a response, the message was successfully sent regardless of status code
                    if (response.statusCode &gt;= 200 &amp;&amp; response.statusCode &lt; 300) {
                        ec.logger.info("Webhook delivered successfully to ${remoteUrl}. Status: ${response.statusCode}")
                    } else {
                        ec.logger.warn("Webhook delivered but server returned non-success status ${response.statusCode} from ${remoteUrl}")
                    }
                    ec.service.sync().name("update#moqui.service.message.SystemMessage")
                        .parameter("systemMessageId", systemMessageId)
                        .parameter("statusId", "SmsgSent")
                        .parameter("processedDate", ec.user.nowTimestamp)
                        .call()
                } catch (Exception e) {
                    // Check if this is an HTTP protocol violation (server responded but with invalid format)
                    if (e.message?.contains("HTTP protocol violation") || e.cause?.message?.contains("HTTP protocol violation")) {
                        ec.logger.warn("Webhook delivered but server returned protocol violation at ${remoteUrl}: ${e.message}")
                        // Server responded, so treat as successful delivery
                        ec.service.sync().name("update#moqui.service.message.SystemMessage")
                            .parameter("systemMessageId", systemMessageId)
                            .parameter("statusId", "SmsgSent")
                            .parameter("processedDate", ec.user.nowTimestamp)
                            .call()
                    } else {
                        // Actual delivery failure (network error, timeout, etc.)
                        ec.logger.error("Webhook delivery error to ${remoteUrl}: ${e.message}", e)
                        def currentSmsg = ec.entity.find("moqui.service.message.SystemMessage")
                            .condition("systemMessageId", systemMessageId)
                            .useCache(false)
                            .one()

                        if (currentSmsg &amp;&amp; currentSmsg.statusId != "SmsgError") {
                            try {
                                ec.service.sync().name("update#moqui.service.message.SystemMessage")
                                    .parameter("systemMessageId", systemMessageId)
                                    .parameter("statusId", "SmsgError")
                                    .call()
                            } catch (Exception ignored) {
                                ec.logger.warn("Ignoring illegal status transition for systemMessageId=${systemMessageId}")
                            }
                        }
                    }
                }
            </script>
        </actions>
    </service>


    <service verb="receive" noun="WebhookEvents" authenticate="false">
        <description>Receive DataFeed documents and dispatch webhook events.</description>
        <implements service="org.moqui.EntityServices.receive#DataFeed"/>
        <actions>
            <iterate list="documentList" entry="doc">
                <set field="logStatus" from="doc.eventStatusId ?: doc.orderHeaderStatusId ?: doc.shipmentCurrentStatusId ?: doc.itemStatusId"/>
                <if condition="doc._type == 'WebhookOrderItem'">
                    <set field="logStatus" from="doc.itemStatusId"/>
                </if>
                <set field="logOrderItemSeqId" from="doc.eventOrderItemSeqId ?: doc.orderItemSeqId"/>
                <log level="info" message=">>> [WebhookDataFeed] docType=${doc._type}, id=${doc._id}, status=${logStatus}, orderItemSeqId=${logOrderItemSeqId}"/>

                <service-call name="co.hotwax.webhook.WebhookServices.process#WebhookDataDocument"
                              in-map="[doc: doc, feedStamp: feedStamp]" ignore-error="true"/>
            </iterate>
        </actions>
    </service>

    <service verb="process" noun="WebhookDataDocument" authenticate="false">
        <in-parameters>
            <parameter name="doc" type="Map" required="true"/>
            <parameter name="feedStamp" type="Timestamp"/>
            <parameter name="allowOrderCompleted" type="Boolean" default-value="false"/>
        </in-parameters>
        <actions>
            <set field="docType" from="doc._type"/>
            <set field="shouldDispatch" from="false"/>
            <set field="topicEnumId" from="null"/>
            <set field="payload" from="[:]"/>
            <set field="previousStatus" from="null"/>
            <set field="orderId" from="doc.orderId"/>
            <set field="shipmentId" from="doc.shipmentId"/>
            <set field="itemsList" from="null"/>
            <set field="orderShipment" from="null"/>
            <set field="orderTypeId" from="doc.orderTypeId"/>

            <!-- Ensure we only process Sales Orders -->
            <if condition="!orderTypeId &amp;&amp; orderId">
                <entity-find-one entity-name="org.apache.ofbiz.order.order.OrderHeader" value-field="oh" cache="true">
                    <field-map field-name="orderId" from="orderId"/>
                </entity-find-one>
                <set field="orderTypeId" from="oh?.orderTypeId"/>
            </if>
            <if condition="orderTypeId &amp;&amp; orderTypeId != 'SALES_ORDER'">
                <!-- <log level="info" message="Skipping webhook processing for non-sales order ${orderId} of type ${orderTypeId}"/> -->
                <return/>
            </if>

            <!-- WEBHOOK ORDER STATUS -->
            <if condition="docType == 'WebhookOrderStatus'">
                <set field="eventStatusId" from="doc.eventStatusId ?: doc.orderHeaderStatusId"/>
                <set field="eventOrderItemSeqId" from="doc.eventOrderItemSeqId ?: doc.orderItemSeqId"/>
                <set field="eventOrderStatusId" from="doc.eventOrderStatusId ?: doc.orderStatusId"/>
                <set field="eventStatusLastUpdatedStamp" from="doc.eventStatusLastUpdatedStamp"/>
                <set field="eventStatusDatetime" from="doc.eventStatusDatetime"/>
                <set field="orderId" from="doc.orderId"/>

                <if condition="eventOrderItemSeqId == '_NA_' || eventOrderItemSeqId == ''">
                    <set field="eventOrderItemSeqId" from="null"/>
                </if>

                <!-- Previous Status Lookup -->
                <if condition="orderId">
                    <entity-find entity-name="org.apache.ofbiz.order.order.OrderStatus" list="statusHistory">
                        <econdition field-name="orderId" from="orderId"/>
                        <econdition field-name="orderItemSeqId" operator="is-null"/>
                        <order-by field-name="-statusDatetime"/>
                        <order-by field-name="-lastUpdatedStamp"/>
                        <order-by field-name="-orderStatusId"/>
                    </entity-find>
                    <set field="previousStatus" from="statusHistory?.size() > 1 ? statusHistory[1].statusId : null"/>
                    
                    <!-- Fallback if fields missing in doc -->
                    <if condition="!eventStatusId &amp;&amp; statusHistory">
                        <set field="eventStatusId" from="statusHistory[0].statusId"/>
                        <set field="eventStatusDatetime" from="statusHistory[0].statusDatetime"/>
                    </if>
                    
                    <!-- Find specific event status entity if ID provided -->
                    <if condition="eventOrderStatusId">
                         <entity-find-one entity-name="org.apache.ofbiz.order.order.OrderStatus" value-field="eventOrderStatusEntity">
                            <field-map field-name="orderStatusId" from="eventOrderStatusId"/>
                        </entity-find-one>
                        <if condition="!eventStatusId &amp;&amp; eventOrderStatusEntity">
                            <set field="eventStatusId" from="eventOrderStatusEntity.statusId"/>
                            <set field="eventStatusDatetime" from="eventOrderStatusEntity.statusDatetime"/>
                            <set field="eventStatusLastUpdatedStamp" from="eventOrderStatusEntity.lastUpdatedStamp"/>
                        </if>
                    </if>
                </if>
                
                <!-- Freshness Checks -->
                <set field="isLatestOrderStatusEvent" from="false"/>
                <set field="isFreshOrderStatusEvent" from="false"/>
                <set field="isNotFutureOrderStatusEvent" from="false"/>
                <if condition="orderId &amp;&amp; !eventOrderItemSeqId">
                    <set field="referenceTs" from="feedStamp ?: eventStatusLastUpdatedStamp ?: ec.user.nowTimestamp"/>
                    <entity-find entity-name="org.apache.ofbiz.order.order.OrderStatus" list="latestStatusList" limit="1">
                        <econdition field-name="orderId" from="orderId"/>
                        <econdition field-name="orderItemSeqId" operator="is-null"/>
                        <order-by field-name="-lastUpdatedStamp"/>
                        <order-by field-name="-statusDatetime"/>
                        <order-by field-name="-orderStatusId"/>
                    </entity-find>
                    <set field="latestStatus" from="latestStatusList ? latestStatusList[0] : null"/>
                    <if condition="latestStatus &amp;&amp; eventOrderStatusId == latestStatus.orderStatusId">
                        <set field="isLatestOrderStatusEvent" from="true"/>
                    </if>
                    <set field="freshTs" from="eventStatusLastUpdatedStamp ?: feedStamp ?: eventStatusDatetime"/>
                    <set field="freshCutoff" from="new java.sql.Timestamp(ec.user.nowTimestamp.time - (30L * 60L * 1000L))"/>
                    <if condition="freshTs &amp;&amp; freshTs &gt;= freshCutoff">
                        <set field="isFreshOrderStatusEvent" from="true"/>
                    </if>
                    <if condition="allowOrderCompleted">
                         <set field="isFreshOrderStatusEvent" from="true"/>
                    </if>
                </if>
                
                <set field="isOrderStatusWebhookTopic" from="eventStatusId in ['ORDER_CREATED', 'ORDER_APPROVED', 'ORDER_COMPLETED', 'ORDER_CANCELLED']"/>
                
                <!-- Rank Check -->
                <set field="eventStatusMatchesHeader" from="true"/>
                <if condition="!allowOrderCompleted">
                <script><![CDATA[
                    def orderStatusRank = ['ORDER_CREATED':10, 'ORDER_APPROVED':20, 'ORDER_COMPLETED':30, 'ORDER_CANCELLED':40]
                    Integer eventRank = orderStatusRank[eventStatusId]
                    Integer headerRank = orderStatusRank[doc.orderHeaderStatusId]
                    if (eventRank != null && headerRank != null && headerRank > eventRank) {
                        eventStatusMatchesHeader = false
                    }
                ]]></script>
                </if>

                <!-- Deferral Logic -->
                 <set field="shipmentCompletedCheck" from="true"/>
                 <set field="orderHasShipment" from="false"/>
                 <if condition="eventStatusId == 'ORDER_COMPLETED' &amp;&amp; orderId">
                    <entity-find entity-name="org.apache.ofbiz.order.order.OrderShipment" list="orderShipments">
                        <econdition field-name="orderId" from="orderId"/>
                    </entity-find>
                    <if condition="orderShipments">
                        <set field="orderHasShipment" from="true"/>
                        <iterate list="orderShipments" entry="os">
                            <entity-find entity-name="org.apache.ofbiz.shipment.shipment.ShipmentStatus"
                                         list="latestShipmentStatus" limit="1">
                                <econdition field-name="shipmentId" from="os.shipmentId"/>
                                <order-by field-name="-lastUpdatedStamp"/>
                                <order-by field-name="-statusDate"/>
                                <order-by field-name="-shipmentStatusId"/>
                            </entity-find>
                            <if condition="latestShipmentStatus &amp;&amp; latestShipmentStatus[0].statusId != 'SHIPMENT_SHIPPED'">
                                <set field="shipmentCompletedCheck" from="false"/>
                            </if>
                        </iterate>
                    </if>
                </if>


                 <set field="shipmentWebhookSent" from="true"/>
                 <if condition="eventStatusId == 'ORDER_COMPLETED' &amp;&amp; orderId &amp;&amp; !allowOrderCompleted">
                    <set field="shipmentWebhookSent" from="false"/>
                    <script><![CDATA[
                        def sentList = ec.entity.find("moqui.service.message.SystemMessage")
                                .condition("systemMessageTypeId", "WebhookNotification")
                                .condition("docControl", orderId)
                                .condition("statusId", "in", ["SmsgSent", "SmsgProduced", "SmsgCreated", "SmsgPrepared"])
                                .orderBy("-createdStamp")
                                .limit(20)
                                .list()
                        for (def sm : sentList) {
                            if (!sm.messageText) continue
                            try {
                                def payload = org.moqui.impl.context.ContextJavaUtil.jacksonMapper.readValue(sm.messageText, Map.class)
                                if (payload?.event_type?.toString() == 'SHIPMENT_SHIPPED') {
                                    shipmentWebhookSent = true
                                    break
                                }
                            } catch (Exception ignored) { }
                        }
                    ]]></script>
                    <if condition="!shipmentWebhookSent">
                        <log level="info" message=">>> [WebhookDataFeed][defer] OrderCompleted deferred until SHIPMENT_SHIPPED webhook is sent orderId=${orderId}"/>
                    </if>
                </if>
                
                <if condition="orderId &amp;&amp; isOrderStatusWebhookTopic &amp;&amp; !eventOrderItemSeqId &amp;&amp; eventStatusMatchesHeader &amp;&amp; isLatestOrderStatusEvent &amp;&amp; isFreshOrderStatusEvent &amp;&amp; shipmentCompletedCheck &amp;&amp; shipmentWebhookSent">
                    <set field="shouldDispatch" from="true"/>
                    <set field="topicEnumId" from="eventStatusId"/>
                    <set field="payload" from="[
                        event_type: eventStatusId,
                        event_source_id: eventOrderStatusId,
                        shopify_order_name: doc.orderName ?: orderId,
                        previous_status: previousStatus,
                        status: eventStatusId,
                        user_id: (doc.eventStatusUserLogin ?: doc.statusUserLogin) ?: ec.user.userId,
                        bill_to: null, 
                        event_date: (doc.eventStatusDatetime ?: eventStatusDatetime) ?: doc.orderEntryDate ?: ec.user.nowTimestamp
                    ]"/>
                    <!-- Order specific item iterator -->
                    <set field="itemsList" from="[]"/>
                    <if condition="doc.shipGroups">
                        <iterate list="doc.shipGroups" entry="sg">
                            <if condition="sg.items">
                                <iterate list="sg.items" entry="item">
                                    <set field="upcValue" from="null"/>
                                     <if condition="item.identifications">
                                        <iterate list="item.identifications" entry="ident">
                                            <if condition="!upcValue &amp;&amp; (ident.upc_type == 'UPCA' || ident.goodIdentificationTypeId == 'UPCA')">
                                                <set field="upcValue" from="ident.upc ?: ident.idValue"/>
                                            </if>
                                        </iterate>
                                        <if condition="!upcValue">
                                            <set field="upcValue" from="item.identifications[0]?.upc ?: item.identifications[0]?.idValue"/>
                                        </if>
                                    </if>
                                    <if condition="!upcValue">
                                        <set field="upcValue" from="item.upc ?: item.idValue"/>
                                    </if>
                                    <script>itemsList.add([sku: item.sku ?: item.productId, upc: upcValue, product_name: item.product_name, quantity: item.quantity])</script>
                                </iterate>
                            </if>
                        </iterate>
                    </if>
                    <set field="payload.items" from="itemsList"/>
                </if>
            </if>

            <!-- WEBHOOK SHIPMENT STATUS -->
            <if condition="docType == 'WebhookShipmentStatus'">
                 <if condition="doc.eventStatusId in ['SHIPMENT_APPROVED', 'SHIPMENT_PACKED', 'SHIPMENT_SHIPPED']">
                    <set field="shipmentId" from="doc.shipmentId"/>
                    <set field="eventShipmentStatusId" from="doc.eventShipmentStatusId ?: doc.shipmentStatusId"/>
                    <set field="eventDate" from="doc.eventDate"/>
                    <set field="eventStatusLastUpdatedStamp" from="doc.eventStatusLastUpdatedStamp"/>

                    <if condition="shipmentId">
                        <!-- Freshness Check Logic -->
                         <entity-find-one entity-name="org.apache.ofbiz.shipment.shipment.ShipmentStatus" value-field="eventShipmentStatusEntity">
                            <field-map field-name="shipmentStatusId" from="eventShipmentStatusId"/>
                        </entity-find-one>
                        <if condition="!eventDate &amp;&amp; eventShipmentStatusEntity">
                            <set field="eventDate" from="eventShipmentStatusEntity.statusDate"/>
                        </if>
                         <if condition="!eventStatusLastUpdatedStamp &amp;&amp; eventShipmentStatusEntity">
                            <set field="eventStatusLastUpdatedStamp" from="eventShipmentStatusEntity.lastUpdatedStamp"/>
                        </if>
                        
                        <set field="shipmentEventReferenceTs" from="feedStamp ?: eventStatusLastUpdatedStamp ?: ec.user.nowTimestamp"/>
                        <entity-find entity-name="org.apache.ofbiz.shipment.shipment.ShipmentStatus" list="latestShipmentStatusList" limit="1">
                            <econdition field-name="shipmentId" from="shipmentId"/>
                            <order-by field-name="-lastUpdatedStamp"/>
                            <order-by field-name="-statusDate"/>
                            <order-by field-name="-shipmentStatusId"/>
                        </entity-find>
                        
                         <set field="latestShipmentStatus" from="latestShipmentStatusList ? latestShipmentStatusList[0] : null"/>
                         <set field="isLatest" from="latestShipmentStatus &amp;&amp; eventShipmentStatusId == latestShipmentStatus.shipmentStatusId"/>
                         
                         <set field="freshTs" from="eventStatusLastUpdatedStamp ?: feedStamp ?: eventDate"/>
                         <set field="freshCutoff" from="new java.sql.Timestamp(ec.user.nowTimestamp.time - (30L * 60L * 1000L))"/>
                         <set field="isFresh" from="freshTs &amp;&amp; freshTs &gt;= freshCutoff"/>
                         
                         <set field="eventStatusMatchesShipment" from="true"/>
                         <script>
                            def shipmentStatusRank = ['SHIPMENT_INPUT':10, 'SHIPMENT_APPROVED':20, 'SHIPMENT_PICKED':25, 'SHIPMENT_PACKED':30, 'SHIPMENT_SHIPPED':40, 'SHIPMENT_DELIVERED':50]
                            Integer eventRank = shipmentStatusRank[doc.eventStatusId]
                            Integer currentRank = shipmentStatusRank[doc.shipmentCurrentStatusId]
                            if (eventRank != null &amp;&amp; currentRank != null &amp;&amp; currentRank > eventRank) eventStatusMatchesShipment = false
                        </script>
                        
                        <if condition="isLatest &amp;&amp; isFresh &amp;&amp; eventStatusMatchesShipment">
                            <set field="shouldDispatch" from="true"/>
                            <set field="topicEnumId" from="doc.eventStatusId"/>
                            
                            <set field="orderShipmentList" from="doc.orderShipments"/>
                            <set field="orderShipment" from="orderShipmentList ? orderShipmentList[0] : null"/>
                            <set field="orderId" from="doc.orderId ?: orderShipment?.orderId"/>
                            
                             <entity-find entity-name="org.apache.ofbiz.shipment.shipment.ShipmentStatus" list="shipmentStatusList">
                                <econdition field-name="shipmentId" from="shipmentId"/>
                                <order-by field-name="-statusDate"/>
                                <order-by field-name="-lastUpdatedStamp"/>
                                <order-by field-name="-shipmentStatusId"/>
                            </entity-find>
                            <set field="previousStatus" from="shipmentStatusList?.size() > 1 ? shipmentStatusList[1].statusId : null"/>
                            
                            <!-- Tracking Code Logic -->
                            <set field="routeSegmentList" from="doc.routeSegments"/>
                            <set field="routeSegment" from="routeSegmentList ? routeSegmentList[0] : null"/>
                            <set field="trackingCode" from="routeSegment?.trackingCode ?: routeSegment?.trackingIdNumber ?: doc.trackingCode"/>
                            <if condition="!trackingCode">
                                <entity-find entity-name="org.apache.ofbiz.shipment.shipment.ShipmentPackageRouteSeg" list="shipmentPackageRouteSegList" limit="1">
                                    <econdition field-name="shipmentId" from="shipmentId"/>
                                    <order-by field-name="-lastUpdatedStamp"/>
                                </entity-find>
                                <set field="shipmentPackageRouteSeg" from="shipmentPackageRouteSegList ? shipmentPackageRouteSegList[0] : null"/>
                                <set field="trackingCode" from="shipmentPackageRouteSeg?.trackingCode"/>
                            </if>
                            
                             <set field="shippingMethod" from="routeSegment?.shipmentMethodDesc ?: routeSegment?.shipmentMethodTypeId ?: doc.shipmentMethodDesc ?: doc.shipmentMethodTypeId"/>
                            
                            <set field="payload" from="[
                                event_type: doc.eventStatusId,
                                event_source_id: eventShipmentStatusId,
                                shopify_order_name: doc.orderName ?: orderShipment?.orderName ?: orderId,
                                shipment_id: shipmentId,
                                facility_id: doc.originFacilityId,
                                facility_name: doc.facilityName,
                                tracking_code: trackingCode,
                                shipping_guide: routeSegment?.trackingUrl, 
                                previous_status: previousStatus,
                                status: doc.eventStatusId,
                                user_id: doc.eventUserLoginId ?: ec.user.userId,
                                shipping_method: shippingMethod,
                                event_date: doc.eventDate ?: ec.user.nowTimestamp
                            ]"/>
                            
                            <set field="itemsList" from="[]"/>
                            <if condition="doc.items">
                                <iterate list="doc.items" entry="item">
                                    <set field="upcValue" from="null"/>
                                    <if condition="item.identifications">
                                        <iterate list="item.identifications" entry="ident">
                                            <if condition="!upcValue &amp;&amp; (ident.upc_type == 'UPCA' || ident.goodIdentificationTypeId == 'UPCA')">
                                                <set field="upcValue" from="ident.upc ?: ident.idValue"/>
                                            </if>
                                        </iterate>
                                        <if condition="!upcValue">
                                            <set field="upcValue" from="item.identifications[0]?.upc ?: item.identifications[0]?.idValue"/>
                                        </if>
                                    </if>
                                    <if condition="!upcValue">
                                        <set field="upcValue" from="item.upc ?: item.idValue"/>
                                    </if>
                                    <script>itemsList.add([sku: item.sku ?: item.productId, upc: upcValue, product_name: item.product_name, quantity: item.quantity])</script>
                                </iterate>
                            </if>
                            <set field="payload.items" from="itemsList"/>
                                                        <!-- Trigger Order Completed Check: Moved to end of actions to ensure sequence -->
                             <set field="triggerOrderCompleted" from="doc.eventStatusId == 'SHIPMENT_SHIPPED' &amp;&amp; orderId"/>
                        </if>
                    </if>
                 </if>
            </if>

            <!-- WEBHOOK ORDER ITEM -->
            <if condition="docType == 'WebhookOrderItem'">
                <if condition="doc.itemStatusId in ['ITEM_BROKERED', 'ITEM_APPROVED', 'ORDER_APPROVED']">
                    <set field="topicEnumId" from="'ITEM_BROKERED'"/>
                </if>
                <if condition="doc.itemStatusId in ['ITEM_REJECTED', 'ORDER_REJECTED']">
                    <set field="topicEnumId" from="'ITEM_REJECTED'"/>
                </if>
                <set field="eventSourceId" from="(doc.orderItemSeqId ?: 'NA') + ':' + (doc.itemStatusId ?: 'NA') + ':' + (doc.eventDate ? doc.eventDate.time : ec.user.nowTimestamp.time)"/>
                
                <if condition="doc.orderId &amp;&amp; (doc.orderItemSeqId ?: doc.eventOrderItemSeqId) &amp;&amp; topicEnumId">
                     <set field="shouldDispatch" from="true"/>
                     <set field="orderId" from="doc.orderId"/>
                     <set field="previousStatus" from="'ITEM_APPROVED'"/>
                     
                     <set field="rejectionReasonId" from="doc.rejectionReasonId ?: doc.varianceReasonEnumId"/>
                     <if condition="!rejectionReasonId &amp;&amp; doc.itemRes">
                        <iterate list="doc.itemRes" entry="res">
                            <if condition="!rejectionReasonId">
                                <set field="rejectionReasonId" from="res.rejectionReasonId ?: res.varianceReasonEnumId"/>
                            </if>
                        </iterate>
                    </if>
                    
                    <set field="upcValue" from="null"/>
                     <if condition="doc.identifications">
                        <iterate list="doc.identifications" entry="ident">
                            <if condition="!upcValue &amp;&amp; (ident.upc_type == 'UPCA' || ident.goodIdentificationTypeId == 'UPCA')">
                                <set field="upcValue" from="ident.upc ?: ident.idValue"/>
                            </if>
                        </iterate>
                        <if condition="!upcValue">
                            <set field="upcValue" from="doc.identifications[0]?.upc ?: doc.identifications[0]?.idValue"/>
                        </if>
                    </if>
                    <if condition="!upcValue">
                        <set field="upcValue" from="doc.upc ?: doc.idValue"/>
                    </if>
                    
                    <set field="payload" from="[
                        event_type: topicEnumId,
                        event_source_id: eventSourceId,
                        shopify_order_name: doc.orderName ?: doc.orderId,
                        order_item_seq_id: doc.orderItemSeqId,
                        sku: doc.sku ?: doc.productId,
                        upc: upcValue,
                        product_name: doc.product_name,
                        previous_status: 'ITEM_APPROVED',
                        status: topicEnumId,
                        user_id: doc.eventUserLoginId ?: ec.user.userId,
                        rejection_reason: rejectionReasonId,
                        event_date: doc.eventDate ?: ec.user.nowTimestamp
                    ]"/>
                </if>
            </if>


            <!-- SHARED PAYLOAD BUILDER -->
            <if condition="shouldDispatch">
                <!-- Resolve Ship Group & Addresses -->
                <set field="shipGroup" from="null"/>
                <if condition="doc.shipGroups">
                     <set field="shipGroup" from="doc.shipGroups[0]"/>
                     <if condition="doc.shipGroupSeqId">
                        <iterate list="doc.shipGroups" entry="sg">
                            <if condition="sg.shipGroupSeqId == doc.shipGroupSeqId">
                                <set field="shipGroup" from="sg"/>
                            </if>
                        </iterate>
                     </if>
                </if>
                
                <set field="paymentPref" from="doc.paymentPrefs ? doc.paymentPrefs[0] : (orderShipment?.paymentPrefs ? orderShipment.paymentPrefs[0] : null)"/>
                
                <set field="billContactList" from="doc.billContacts ?: doc.contactMechs"/>
                <if condition="!billContactList &amp;&amp; orderShipment">
                     <set field="billContactList" from="orderShipment.billContacts"/>
                </if>
                
                <set field="billContact" from="billContactList ? billContactList[0] : null"/>
                <if condition="billContactList">
                    <iterate list="billContactList" entry="bc">
                        <if condition="bc.contactMechPurposeTypeId == 'BILLING_LOCATION'">
                            <set field="billContact" from="bc"/>
                        </if>
                    </iterate>
                     <if condition="!billContact?.billToName">
                        <iterate list="billContactList" entry="bc">
                            <if condition="bc.billToName">
                                <set field="billContact" from="bc"/>
                            </if>
                        </iterate>
                    </if>
                </if>
                
                <set field="billToNameFallback" from="null"/>
                <if condition="!billContact?.billToName &amp;&amp; orderId">
                    <entity-find entity-name="org.apache.ofbiz.order.order.OrderContactMech" list="billingContactMechList" limit="1">
                        <econdition field-name="orderId" from="orderId"/>
                        <econdition field-name="contactMechPurposeTypeId" value="BILLING_LOCATION"/>
                        <econdition field-name="thruDate" operator="is-null"/>
                        <order-by field-name="-fromDate"/>
                    </entity-find>
                    <set field="billingContactMech" from="billingContactMechList ? billingContactMechList[0] : null"/>
                    <if condition="billingContactMech?.contactMechId">
                        <entity-find-one entity-name="org.apache.ofbiz.party.contact.PostalAddress" value-field="billingPostalAddress">
                            <field-map field-name="contactMechId" from="billingContactMech.contactMechId"/>
                        </entity-find-one>
                        <set field="billToNameFallback" from="billingPostalAddress?.toName"/>
                    </if>
                </if>
                
                <set field="adjustmentList" from="doc.adjustments"/>
                <if condition="!adjustmentList &amp;&amp; orderShipment">
                    <set field="adjustmentList" from="orderShipment.adjustments"/>
                </if>
                <set field="shippingCost" from="0"/>
                <if condition="adjustmentList">
                    <iterate list="adjustmentList" entry="adj">
                        <if condition="adj.adjustmentTypeId == 'SHIPPING_CHARGES'">
                            <set field="shippingCost" from="shippingCost + (adj.adjustmentAmount ?: 0)"/>
                        </if>
                    </iterate>
                </if>
                
                <set field="grandTotal" from="orderShipment?.grandTotal ?: doc.grandTotal ?: 0"/>
                <set field="orderPrice" from="grandTotal - shippingCost"/>
                <set field="countryCode" from="null"/>
                 <set field="defaultLocaleString" from="orderShipment?.defaultLocaleString ?: doc.defaultLocaleString"/>
                <if condition="defaultLocaleString">
                    <set field="countryCode" from="defaultLocaleString.substring(defaultLocaleString.length()-2)"/>
                </if>
                
                <!-- Shared Fields Merge -->
                <script>
                    payload.putAll([
                        facility_id: shipGroup?.facilityId ?: doc.originFacilityId,
                        facility_name: shipGroup?.facilityName ?: doc.facilityName,
                        brand: orderShipment?.storeName ?: doc.storeName,
                        country: countryCode, 
                        channel: orderShipment?.salesChannelDesc ?: doc.salesChannelDesc,
                        payment_type: paymentPref?.paymentMethodDesc,
                        bill_to: billContact?.billToName ?: billToNameFallback,
                        currency: orderShipment?.currencyUom ?: doc.currencyUom,
                        shipping_cost: shippingCost,
                        total_price: grandTotal,
                        order_price: orderPrice
                    ])
                    if (!payload.shipping_method) payload.put("shipping_method", shipGroup?.shipmentMethodDesc ?: shipGroup?.shipmentMethodTypeId)
                </script>

                <service-call name="co.hotwax.webhook.WebhookServices.dispatch#WebhookEvent"
                              in-map="[topicEnumId: topicEnumId, orderId: orderId, shipmentId: shipmentId, orderItemSeqId: doc.orderItemSeqId,
                                      eventContext: [payload: payload, previousStatus: previousStatus]]" ignore-error="true"/>

                <!-- Trigger deferred Order Completed check if all shipments shipped -->
                <if condition="triggerOrderCompleted">
                    <script><![CDATA[
                        def allShipped = true
                        def osList = ec.entity.find("org.apache.ofbiz.order.order.OrderShipment").condition("orderId", orderId).list()
                        for (def os : (osList ?: [])) {
                            def lst = ec.entity.find("org.apache.ofbiz.shipment.shipment.ShipmentStatus")
                                    .condition("shipmentId", os.shipmentId)
                                    .orderBy("-lastUpdatedStamp").orderBy("-statusDate").orderBy("-shipmentStatusId")
                                    .limit(1).list()
                            if (lst && lst[0].statusId != 'SHIPMENT_SHIPPED') { allShipped = false; break }
                        }
                        if (allShipped) {
                            def completedList = ec.entity.find("org.apache.ofbiz.order.order.OrderStatus")
                                    .condition("orderId", orderId)
                                    .condition("orderItemSeqId", null)
                                    .condition("statusId", "ORDER_COMPLETED")
                                    .orderBy("-statusDatetime").orderBy("-lastUpdatedStamp").orderBy("-orderStatusId")
                                    .limit(1).list()
                            if (completedList) {
                                 def cond = ec.entity.conditionFactory.makeCondition("eventOrderStatusId", org.moqui.entity.EntityCondition.ComparisonOperator.IN, [completedList[0].orderStatusId])
                                 def docs = ec.entityFacade.getDataDocuments("WebhookOrderStatus", cond, null, null)
                                 if (docs) {
                                    docs.each { d ->
                                        ec.service.sync().name("co.hotwax.webhook.WebhookServices.process#WebhookDataDocument")
                                                .parameters([doc: d, feedStamp: ec.user.nowTimestamp, allowOrderCompleted: true]).call()
                                    }
                                 }
                            }
                        }
                    ]]></script>
                </if>
            </if>
        </actions>
    </service>
    
    <service verb="poll" noun="WebhookOrderStatus">
        <description>
            Poll OrderStatus rows and dispatch webhook events (manual invocation, non-job version).
        </description>

        <in-parameters>
            <parameter name="fromDate" type="Timestamp"/>
            <parameter name="thruDate" type="Timestamp"/>
            <parameter name="statusIds" type="List"/>
            <parameter name="orderId"/>
        </in-parameters>

        <out-parameters>
            <parameter name="documentCount" type="Long"/>
        </out-parameters>

        <actions>
            <script>
                // Disable authorization for this service execution
                import org.moqui.entity.EntityCondition
                ec.artifactExecutionFacade.disableAuthz()
                ec.userFacade.loginAnonymousIfNoUser()
            </script>
            <set field="thruDate" from="thruDate ?: ec.user.nowTimestamp"/>
            <set field="statusIds" from="statusIds ?: ['ORDER_CREATED', 'ORDER_APPROVED', 'ORDER_COMPLETED']"/>

            <entity-find entity-name="org.apache.ofbiz.order.order.OrderStatus" list="orderStatusList">
                <econdition field-name="orderItemSeqId" operator="is-null"/>
                <econdition field-name="statusId" operator="in" from="statusIds"/>
                <econdition field-name="lastUpdatedStamp" operator="greater-equals" from="fromDate" ignore-if-empty="true"/>
                <econdition field-name="lastUpdatedStamp" operator="less" from="thruDate"/>
                <econdition field-name="orderId" from="orderId" ignore-if-empty="true"/>
                <order-by field-name="lastUpdatedStamp"/>
                <order-by field-name="statusDatetime"/>
            </entity-find>

            <set field="orderStatusIds" from="orderStatusList*.orderStatusId"/>

            <if condition="orderStatusIds">
                <script>
                    def condition = ec.entity.conditionFactory.makeCondition("eventOrderStatusId", EntityCondition.ComparisonOperator.IN, orderStatusIds)
                    context.documentList = ec.entityFacade.getDataDocuments("WebhookOrderStatus", condition, null, null)
                </script>
            </if>

            <set field="documentCount" from="documentList ? documentList.size() : 0"/>

            <if condition="documentList">
                <service-call name="co.hotwax.webhook.WebhookServices.receive#WebhookEvents" in-map="[documentList: documentList]" ignore-error="true"/>
            </if>
            <script>
                // Re-enable authorization
                ec.artifactExecutionFacade.enableAuthz()
            </script>
        </actions>
    </service>
</services>
