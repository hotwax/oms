<secas xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-eca-3.xsd">
    <!-- FIXME: This should be done using the DataFeed flow-->
    <seca id="ProcessOrderItemAllocation" service="co.hotwax.oms.impl.OrderReservationServices.process#OrderItemAllocation" when="tx-commit">
        <condition><expression>allocatedShipGroupSeqId</expression></condition>
        <actions>
            <service-call name="co.hotwax.oms.search.SearchServices.index#OrderItem" in-map="[orderId:orderId, orderItemSeqId: orderItemSeqId]"
                    ignore-error="true" />
            <service-call name="co.hotwax.oms.search.SearchServices.index#Reservation" in-map="[orderId:orderId, orderItemSeqId: orderItemSeqId]"
                          ignore-error="true" />
        </actions>
    </seca>
    <!-- We don't need this seca rule as we are not using OISGIR doc from Moqui. Also we already have fulfillment status in order doc which is getting updated on item stats change. -->
    <!-- Also, in case of redirection of cancelOrderItemShipGrpInvRes, we are are handling deleteOrderItemShipGrpInvRes in HC/OMS separately, so nothing to take care here for deleting reservation
       Refer MR: https://git.hotwax.co/commerce/oms/-/merge_requests/6050
     -->
    <!--
    <seca id="CancelReservation" service="delete#org.apache.ofbiz.order.order.OrderItemShipGrpInvRes" when="tx-commit">
        <actions>
            <service-call name="co.hotwax.oms.search.SearchServices.update#OISGIRIFulfillmentStatus"
                          in-map="context"
                          ignore-error="true" />
        </actions>
    </seca> -->

    <seca service="co.hotwax.oms.impl.FulfillmentOrderServices.create#FulfillmentOrderIssuance" when="tx-commit">
        <actions>
            <iterate list="issuedOrderItems" entry="item">
                <service-call name="co.hotwax.oms.search.SearchServices.index#OrderItem"
                      in-map="[orderId:item.orderId, orderItemSeqId: item.orderItemSeqId]"
                      ignore-error="true" />
            </iterate>
        </actions>
    </seca>
    <seca id="OrderItemStatusChange" service="update#org.apache.ofbiz.order.order.OrderItem" when="tx-commit">
        <condition><expression>statusChanged</expression></condition>
        <actions>
            <service-call name="co.hotwax.oms.search.SearchServices.index#OrderItem" in-map="[orderId:orderId, orderItemSeqId: orderItemSeqId]"
                          ignore-error="true" />
        </actions>
    </seca>

    <!-- SECA to index order in Solr when order status becomes COMPLETED or CANCELLED -->
    <seca id="OrderHeaderStatusChange" service="update#org.apache.ofbiz.order.order.OrderHeader" when="tx-commit">
        <condition>
            <expression>statusChanged</expression>
        </condition>
        <actions>
            <service-call name="co.hotwax.oms.search.SearchServices.index#OrderHeader" in-map="[orderId:orderId]"
                          ignore-error="true" />
        </actions>
    </seca>
    <seca id="OrderItemCompleted" service="update#org.apache.ofbiz.order.order.OrderItem" when="post-commit">
        <condition>
            <expression>statusChanged &amp;&amp; statusId == 'ITEM_COMPLETED'</expression>
        </condition>
        <actions>
            <service-call name="co.hotwax.oms.order.OrderServices.delete#OrderItemReservations" in-map="[orderId:orderId, orderItemSeqId: orderItemSeqId]"
                          ignore-error="true" disable-authz="true"/>
        </actions>
    </seca>
    <seca id="OrderItemComplete" service="update#org.apache.ofbiz.order.order.OrderItem" when="post-commit">
        <condition>
            <expression>statusChanged &amp;&amp; statusId == 'ITEM_COMPLETED'</expression>
        </condition>
        <actions>
            <service-call name="co.hotwax.oms.order.OrderServices.check#OrderItemAndCapturePayment" in-map="[orderId:orderId]"
                          ignore-error="true" disable-authz="true"/>
        </actions>
    </seca>

    <!-- Seca rule on order Complete to generate generic order feed for other ERP system -->
    <seca id="OrderStatusChange" service="update#org.apache.ofbiz.order.order.OrderHeader" when="tx-commit">
        <condition>
            <expression>statusChanged &amp;&amp; statusId == 'ORDER_COMPLETED'</expression>
        </condition>
        <actions>
            <service-call name="co.hotwax.oms.order.OrderServices.send#OrderWebhook" in-map="[orderId:orderId,topicEnumId:'WEBHOOK_ODR_COMPLETE']" async="true" disable-authz="true"/>
        </actions>
    </seca>
    <seca id="SendCancellationEmail" service="co.hotwax.orderledger.order.OrderServices.cancel#SalesOrderItems" when="post-commit">
        <condition>
            <expression>orderId &amp;&amp; cancelledItems</expression>
        </condition>
        <actions>
            <script>
                orderItemShipGroup = ec.entity.find("org.apache.ofbiz.order.order.OrderItemShipGroup").condition("orderId", orderId).condition("shipGroupSeqId", cancelledItems[0].shipGroupSeqId).one()
            </script>
            <set field="hasParentType" from="co.hotwax.oms.util.OmsUtil.hasParentType(ec.ecfi , 'org.apache.ofbiz.shipment.shipment.ShipmentMethodType', 'shipmentMethodTypeId', orderItemShipGroup.shipmentMethodTypeId, 'parentTypeId', 'STOREPICKUP')" type="Boolean"/>
            <if condition="!hasParentType">
                <return/>
            </if>
            <set field="emailType" value="CANCEL_BOPIS_ORDER"/>
            <set field="orderItems" from="cancelledItems"/>
            <service-call name="co.hotwax.orderledger.order.email.EmailServices.send#EmailOnOrderEvents" in-map="context" ignore-error="true" async="true"/>
        </actions>
    </seca>

    <seca id="pickerUpdate" service="co.hotwax.oms.party.PartyServices.store#Picker"
          when="post-service">
        <actions>
            <service-call name="co.hotwax.oms.search.SearchServices.index#Picker" in-map="[partyId:partyId]"/>
        </actions>
    </seca>

    <seca id="ShopifyOrderSplitAsnItems" service="co.hotwax.oms.order.OrderServices.create#SalesOrder" when="post-service">
        <condition><expression>orderId</expression></condition>
        <actions>
            <service-call name="co.hotwax.oms.order.OrderServices.split#OrderASNItems" in-map="[orderId:orderId]"/>
        </actions>
    </seca>

    <seca id="ShopifyOrderSetPreorderPromisedDate" service="co.hotwax.oms.order.OrderServices.split#OrderASNItems" when="post-service">
        <condition><expression>orderId</expression></condition>
        <actions>
            <service-call name="co.hotwax.oms.order.OrderServices.set#PreOrderPromisedDate" in-map="[orderId:orderId]"/>
        </actions>
    </seca>

    <seca id="ShopifyOrderApproveAndAllocate" service="co.hotwax.oms.order.OrderServices.set#PreOrderPromisedDate" when="post-service">
        <condition><expression>orderId</expression></condition>
        <actions>
            <service-call name="co.hotwax.oms.order.OrderServices.approve#Order" in-map="[orderId: orderId]"/>
        </actions>
    </seca>
    <seca id="ReserveAndIssueInventoryForPOSOrders" service="co.hotwax.oms.order.OrderServices.create#SalesOrder" when="post-service">
        <condition><expression>orderId</expression></condition>
        <actions>
            <service-call name="co.hotwax.oms.order.OrderServices.create#POSOrderReservationAndIssuance" in-map="context" ignore-error="true"/>
        </actions>
    </seca>
    <seca id="IndexOrder" service="co.hotwax.oms.order.OrderServices.create#SalesOrder" when="tx-commit">
        <condition>
            <expression>orderId</expression>
        </condition>
        <actions>
            <if condition="orderId">
                <service-call name="co.hotwax.oms.search.SearchServices.index#OrderHeader" in-map="[orderId:orderId]" ignore-error="true"/>
            </if>
        </actions>
    </seca>
</secas>